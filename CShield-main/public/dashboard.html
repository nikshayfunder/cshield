<!doctype html>
<html lang="en" class="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CShield</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j7kGICpbJzi3sRoqbZbE8R9uMB6vT9A72G2z8j0=" crossorigin=""></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--bg:#09090b;--primary:#6366f1;--accent:#a855f7}
html,body{height:100%;scroll-behavior:smooth}
body{font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background-color:var(--bg);color:#e4e4e7;-webkit-font-smoothing:antialiased}
.glass{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(10px);transition:transform .2s,background .2s;overflow:hidden;position:relative}
.glass:hover{background:rgba(255,255,255,0.05);transform:translateY(-1px);box-shadow:0 10px 40px -10px rgba(0,0,0,0.5)}
.glass::after{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(800px circle at var(--mouse-x,0) var(--mouse-y,0),rgba(255,255,255,0.06),transparent 40%);opacity:0;transition:opacity .3s;pointer-events:none}
.glass:hover::after{opacity:1}
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);backdrop-filter:blur(4px);z-index:500;transition:opacity .2s}
.modal.hidden{opacity:0;pointer-events:none}
@keyframes pulseGlow{0%{box-shadow:0 0 0 rgba(139,92,246,0)}50%{box-shadow:0 0 32px rgba(139,92,246,.18)}100%{box-shadow:0 0 0 rgba(139,92,246,0)}}
@keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.bgfx{position:fixed;inset:0;background:
radial-gradient(40% 30% at 15% 10%,rgba(139,92,246,.10),transparent 60%),
radial-gradient(30% 30% at 85% 0,rgba(59,130,246,.08),transparent 60%),
radial-gradient(50% 40% at 50% 100%,rgba(16,185,129,.06),transparent 60%);filter:blur(44px);pointer-events:none}
.card{transition:transform .2s ease,box-shadow .2s ease}
.card:hover{transform:translateY(-2px)}
.kpi{animation:pulseGlow 7s ease-in-out infinite}
.dot{width:6px;height:6px;border-radius:9999px;display:inline-block}
.spark{position:absolute;inset:0;background:
radial-gradient(circle at 20% 30%,rgba(255,255,255,.06),transparent 30%),
radial-gradient(circle at 80% 20%,rgba(139,92,246,.08),transparent 35%),
radial-gradient(circle at 60% 80%,rgba(59,130,246,.06),transparent 35%)}
.badge{display:inline-flex;align-items:center;gap:.35rem;padding:.28rem .6rem;border-radius:.6rem;border:1px solid rgba(64,64,64,.6);background:rgba(10,10,12,.6);font-size:.7rem}
.hicon{width:18px;height:18px}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.2)}
.leaflet-container{background:#09090b!important;font-family:'Inter',sans-serif}
.leaflet-popup-content-wrapper,.leaflet-popup-tip{background:rgba(24,24,27,0.95);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.1);color:#fff;border-radius:.75rem}
.leaflet-popup-content{margin:12px}
.leaflet-popup-tip{box-shadow:none}
</style>
</head>
<body class="bg-[var(--bg)] text-zinc-200 antialiased min-h-screen overflow-x-hidden">
<div class="bgfx"></div>

<div class="fixed inset-0 z-[-1] pointer-events-none overflow-hidden">
  <div class="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-violet-500/10 rounded-full blur-[120px]"></div>
  <div class="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-fuchsia-500/10 rounded-full blur-[120px]"></div>
</div>

<div class="flex flex-col lg:flex-row min-h-screen">
  <aside class="lg:w-72 border-b lg:border-b-0 lg:border-r border-neutral-800/80 bg-black/40 backdrop-blur-xl flex lg:flex-col justify-between p-5 z-40 sticky top-0 lg:h-screen">
    <div class="flex flex-col gap-8">
      <div class="flex items-center gap-3 px-2">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-violet-500 to-fuchsia-600 flex items-center justify-center shadow-lg shadow-violet-500/30">
          <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
        </div>
        <div>
          <span class="font-bold text-zinc-100 tracking-tight block leading-none">CShield</span>
          <span class="text-[10px] uppercase tracking-[0.2em] text-zinc-500 font-medium">Edge Security</span>
        </div>
      </div>
      <nav class="flex lg:flex-col gap-1 overflow-x-auto lg:overflow-visible no-scrollbar text-sm">
        <a href="/dashboard" id="nav-overview" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 3.5L3 9v11h6v-7h6v7h6V9z"/>
          </svg>
          <span>Overview</span>
        </a>
        <a href="/analytics" id="nav-traffic" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 5h16v2H4V5zm0 4h10v2H4V9zm0 4h7v2H4v-2zm9 0h7v2h-7v-2z"/>
          </svg>
          <span>Traffic</span>
        </a>
        <a href="/features" id="nav-features" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 6h16v2H4V6zm0 4h10v2H4v-2zm0 4h7v2H4v-2zm9 0h7v2h-7v-2z"/>
          </svg>
          <span>Features</span>
        </a>
        <a href="/proxies" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 5h18v4H3V5zm0 5h18v9H3v-9zm2 2v5h14v-5H5z"/>
          </svg>
          <span>Proxies</span>
        </a>
        <a href="/add_proxy" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 17v-4H6v-2h4V7h2v4h4v2h-4v4z"/>
          </svg>
          <span>Add Proxy</span>
        </a>
        <a href="/settings" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 8a4 4 0 1 0 .001 8.001A4 4 0 0 0 12 8zm8.94 4a7.96 7.96 0 0 0-.16-1.61l2.07-1.62l-2-3.46l-2.49 1a8.24 8.24 0 0 0-2.79-1.62l-.42-2.65H9.85l-.42 2.65a8.24 8.24 0 0 0-2.79 1.62l-2.49-1l-2 3.46l2.07 1.62A7.96 7.96 0 0 0 3.06 12c0 .55.06 1.09.16 1.61L1.15 15.23l2 3.46l2.49-1a8.24 8.24 0 0 0 2.79 1.62l.42 2.65h4.31l.42-2.65a8.24 8.24 0 0 0 2.79-1.62l2.49 1l2-3.46l-2.07-1.62c.1-.52.16-1.06.16-1.61z"/>
          </svg>
          <span>Settings</span>
        </a>
      </nav>
    </div>
    <div class="hidden lg:block">
      <div class="p-4 rounded-xl bg-gradient-to-b from-neutral-900/80 to-neutral-950 border border-white/10">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <div class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></div>
            <span class="text-xs font-mono text-zinc-300">OPERATIONAL</span>
          </div>
          <span class="text-xs font-mono text-zinc-500">Edge Shield</span>
        </div>
        <div class="space-y-2">
          <div class="flex justify-between text-[10px] uppercase tracking-wider text-zinc-500">
            <span>Load</span><span>Stable</span>
          </div>
          <div class="h-1 w-full bg-zinc-800 rounded-full overflow-hidden">
            <div class="h-full w-1/3 bg-emerald-500 rounded-full"></div>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <main class="flex-1 p-4 lg:p-8 w-full max-w-[1920px] mx-auto">
    <div id="tab-overview" class="space-y-6">
    <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 pb-2">
      <div>
        <h1 class="text-2xl font-semibold text-white tracking-tight">CShield Overview</h1>
        <p class="text-sm text-zinc-500 mt-1">Real-time telemetry & threat mitigation from your edge nodes.</p>
      </div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 lg:gap-6">
      <div class="glass kpi rounded-2xl p-5 flex flex-col justify-between">
        <div>
          <p class="text-[11px] font-medium uppercase tracking-widest text-zinc-500">Live RPS</p>
          <div id="m_requests" class="mt-2 text-3xl font-semibold text-white">0</div>
        </div>
        <span class="mt-1 text-[11px] font-medium tracking-widest text-emerald-400">REQ/S</span>
      </div>
      <div class="glass kpi rounded-2xl p-5 flex flex-col justify-between">
        <div>
          <p class="text-[11px] font-medium uppercase tracking-widest text-zinc-500">Mitigated</p>
          <div id="m_blocked" class="mt-2 text-3xl font-semibold text-rose-400">0</div>
        </div>
        <span class="mt-1 text-[11px] font-medium tracking-widest text-rose-400">BLOCKED</span>
      </div>
      <div class="glass kpi rounded-2xl p-5 flex flex-col justify-between">
        <div>
          <p class="text-[11px] font-medium uppercase tracking-widest text-zinc-500">Legitimate</p>
          <div id="m_proxied" class="mt-2 text-3xl font-semibold text-emerald-400">0</div>
        </div>
        <span class="mt-1 text-[11px] font-medium tracking-widest text-indigo-400">ALLOWED</span>
      </div>
      <div class="glass kpi rounded-2xl p-5 flex flex-col justify-between">
        <div>
          <p class="text-[11px] font-medium uppercase tracking-widest text-zinc-500">Challenged</p>
          <div id="m_captcha" class="mt-2 text-3xl font-semibold text-amber-300">0</div>
        </div>
        <span class="mt-1 text-[11px] font-medium tracking-widest text-amber-300">CAPTCHA</span>
      </div>
      <div class="glass kpi rounded-2xl p-5 flex flex-col justify-between">
        <div>
          <p class="text-[11px] font-medium uppercase tracking-widest text-zinc-500">Throttled</p>
          <div id="m_throttled" class="mt-2 text-3xl font-semibold text-sky-300">0</div>
        </div>
        <span class="mt-1 text-[11px] font-medium tracking-widest text-sky-300">THROTTLED</span>
      </div>
      <div class="hidden">
        <span id="m_errors"></span>
        <span id="m_in"></span>
        <span id="m_out"></span>
        <span id="m_peers"></span>
        <span id="m_lb"></span>
      </div>
    </section>

    <section class="grid gap-6 lg:grid-cols-3">
      <div class="lg:col-span-2 glass rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <div class="text-sm font-semibold text-zinc-200">Traffic Velocity</div>
            <div class="text-xs text-zinc-500">Real-time request volume analysis.</div>
          </div>
          <div class="flex items-center gap-2 text-[11px] text-zinc-500">
            <span class="inline-flex h-1.5 w-1.5 rounded-full bg-violet-400"></span>
            Live
          </div>
        </div>
        <div class="h-48 md:h-56 w-full">
          <svg id="rpsChart" viewBox="0 0 60 40" class="w-full h-full">
            <defs>
              <linearGradient id="rpsFillGradient" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#6366f1" stop-opacity="0.3"/>
                <stop offset="100%" stop-color="#6366f1" stop-opacity="0"/>
              </linearGradient>
            </defs>
            <path id="rpsFill" d="" fill="url(#rpsFillGradient)"></path>
            <path id="rpsLine" d="" stroke="#818cf8" stroke-width="0.8" fill="none" vector-effect="non-scaling-stroke"></path>
          </svg>
        </div>
      </div>

      <div class="glass rounded-2xl p-6 flex flex-col justify-between">
        <div>
          <div class="flex items-center justify-between mb-4">
            <div>
              <div class="text-sm font-semibold text-zinc-200">System Health</div>
              <div class="text-xs text-zinc-500">Node resource allocation.</div>
            </div>
            <span class="inline-flex items-center gap-2 text-[11px] text-zinc-500">
              <span class="h-1.5 w-1.5 rounded-full bg-emerald-500"></span>
              Stable
            </span>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col items-center gap-2">
              <div class="relative w-20 h-20">
                <svg viewBox="0 0 36 36" class="w-full h-full text-neutral-700">
                  <path stroke="currentColor" stroke-width="3.2" fill="none"
                        d="M18 2a16 16 0 1 1 0 32a16 16 0 1 1 0-32z"/>
                  <path id="cpuArc" class="text-indigo-400" stroke="currentColor" stroke-width="3.2" fill="none"
                        stroke-linecap="round"
                        stroke-dasharray="0 100"
                        d="M18 2a16 16 0 1 1 0 32a16 16 0 1 1 0-32z"/>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <div id="cpuPct" class="text-sm font-semibold">--%</div>
                </div>
              </div>
              <div class="text-xs text-zinc-400">CPU</div>
            </div>

            <div class="flex flex-col items-center gap-2">
              <div class="relative w-20 h-20">
                <svg viewBox="0 0 36 36" class="w-full h-full text-neutral-700">
                  <path stroke="currentColor" stroke-width="3.2" fill="none"
                        d="M18 2a16 16 0 1 1 0 32a16 16 0 1 1 0-32z"/>
                  <path id="memArc" class="text-fuchsia-400" stroke="currentColor" stroke-width="3.2" fill="none"
                        stroke-linecap="round"
                        stroke-dasharray="0 100"
                        d="M18 2a16 16 0 1 1 0 32a16 16 0 1 1 0-32z"/>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center">
                  <div id="memPct" class="text-sm font-semibold">--%</div>
                </div>
              </div>
              <div class="text-xs text-zinc-400">MEM</div>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-2 gap-3 text-[11px]">
            <div class="flex flex-col gap-1">
              <div class="text-zinc-500 uppercase tracking-[0.14em]">Load Balancer</div>
              <div id="lbStatusWrap" class="inline-flex items-center justify-between px-2.5 py-1.5 rounded-md border border-neutral-700 bg-neutral-950/40 text-zinc-300">
                <span class="text-[10px] tracking-[0.18em] uppercase text-zinc-500">LB</span>
                <span id="lbStatusText" class="font-mono ml-2">0/0</span>
              </div>
            </div>
            <div class="flex flex-col gap-1">
              <div class="text-zinc-500 uppercase tracking-[0.14em]">Peers</div>
              <div id="peerStatusWrap" class="inline-flex items-center justify-between px-2.5 py-1.5 rounded-md border border-neutral-700 bg-neutral-950/40 text-zinc-300">
                <span class="text-[10px] tracking-[0.18em] uppercase text-zinc-500">Peers</span>
                <span id="peerStatusText" class="font-mono ml-2">0/0</span>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-4 text-[11px] text-zinc-500">
          <span id="sysNote">Approximated from current traffic patterns.</span>
        </div>
      </div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6 mt-4">
      <div class="glass rounded-2xl p-5 flex flex-col justify-between">
        <div>
          <p class="text-[11px] font-medium uppercase tracking-widest text-zinc-500">Network Inbound</p>
          <div class="mt-2 flex items-baseline gap-2">
            <div id="netInRate" class="text-2xl font-semibold text-emerald-300">0.00 Mbps</div>
            <span class="text-[10px] text-zinc-500 uppercase tracking-[0.18em]">LIVE</span>
          </div>
          <p class="mt-1 text-[11px] text-zinc-500">
            Total: <span id="netInTotal" class="text-zinc-300">0 B</span>
          </p>
        </div>
        <div class="mt-3 h-16">
          <svg viewBox="0 0 60 40" class="w-full h-full">
            <defs>
              <linearGradient id="netInFillGradient" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#22c55e" stop-opacity="0.35"/>
                <stop offset="100%" stop-color="#22c55e" stop-opacity="0"/>
              </linearGradient>
            </defs>
            <path id="netInFill" d="" fill="url(#netInFillGradient)"></path>
            <path id="netInLine" d="" stroke="#4ade80" stroke-width="0.8" fill="none" vector-effect="non-scaling-stroke"></path>
          </svg>
        </div>
      </div>

      <div class="glass rounded-2xl p-5 flex flex-col justify-between">
        <div>
          <p class="text-[11px] font-medium uppercase tracking-widest text-zinc-500">Network Outbound</p>
          <div class="mt-2 flex items-baseline gap-2">
            <div id="netOutRate" class="text-2xl font-semibold text-sky-300">0.00 Mbps</div>
            <span class="text-[10px] text-zinc-500 uppercase tracking-[0.18em]">LIVE</span>
          </div>
          <p class="mt-1 text-[11px] text-zinc-500">
            Total: <span id="netOutTotal" class="text-zinc-300">0 B</span>
          </p>
        </div>
        <div class="mt-3 h-16">
          <svg viewBox="0 0 60 40" class="w-full h-full">
            <defs>
              <linearGradient id="netOutFillGradient" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#38bdf8" stop-opacity="0.35"/>
                <stop offset="100%" stop-color="#38bdf8" stop-opacity="0"/>
              </linearGradient>
            </defs>
            <path id="netOutFill" d="" fill="url(#netOutFillGradient)"></path>
            <path id="netOutLine" d="" stroke="#38bdf8" stroke-width="0.8" fill="none" vector-effect="non-scaling-stroke"></path>
          </svg>
        </div>
      </div>
    </section>


    <section class="glass rounded-2xl p-6 hidden">
      <div class="flex justify-between items-center mb-3">
        <div class="text-sm font-semibold text-zinc-200">Connection Resets</div>
        <button id="refreshBans" class="rounded-md bg-neutral-800 hover:bg-neutral-700 px-3 py-1.5 text-xs">Refresh</button>
      </div>
      <div class="text-xs text-zinc-500 mb-2">Recent TCP resets per IP (no long-lived bans).</div>
      <div class="overflow-auto max-h-80">
        <table class="w-full text-sm">
          <thead class="text-zinc-500 text-[11px] uppercase tracking-wide border-b border-white/5">
            <tr>
              <th class="text-left font-medium py-1">IP</th>
              <th class="text-left font-medium py-1">Resets</th>
              <th class="text-left font-medium py-1">Last Reset</th>
              <th class="text-left font-medium py-1"></th>
            </tr>
          </thead>
          <tbody id="bansBody"></tbody>
        </table>
      </div>
      <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:items-center">
        <div class="flex-1 flex items-center gap-2">
          <input id="banSearchIp" type="text" placeholder="Search IP…" class="w-full rounded-md bg-neutral-950/60 border border-neutral-800 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-violet-600">
        </div>
        <div class="flex items-center gap-2">
          <button id="banSearchBtn" class="rounded-md bg-neutral-800 hover:bg-neutral-700 px-3 py-1.5 text-xs">Search IP</button>
          <button id="banClearAll" class="rounded-md bg-rose-600 hover:bg-rose-500 px-3 py-1.5 text-xs">Clear All</button>
        </div>
      </div>

      <div class="mt-4 space-y-2">
        <div class="flex flex-col sm:flex-row sm:items-center gap-2">
          <input id="banBlockIp" type="text" placeholder="Temporarily block IP (e.g. 1.2.3.4)" class="flex-1 rounded-md bg-neutral-950/60 border border-neutral-800 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-rose-500">
          <input id="banBlockTTL" type="number" min="1" value="3600" placeholder="TTL (s)" class="w-28 rounded-md bg-neutral-950/60 border border-neutral-800 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-rose-500">
          <button id="banBlockBtn" class="rounded-md bg-rose-600 hover:bg-rose-500 px-3 py-1.5 text-xs font-medium">
            Temp Block & Reset
          </button>
        </div>
        <div id="banBlockMsg" class="text-xs text-zinc-500"></div>
      </div>

      <div id="banSearchResult" class="text-xs text-zinc-500 mt-2"></div>
      <div id="bansMsg" class="text-xs text-zinc-500 mt-2"></div>
    </section>

    <section class="glass rounded-2xl p-6 hidden">
      <div class="text-sm font-semibold text-zinc-200 mb-3">HTTP Status</div>
      <div id="statusMap" class="grid grid-cols-2 md:grid-cols-6 gap-2"></div>
    </section>
    </div>

  </main>
</div>

<script>
function fmt(n){return Intl.NumberFormat().format(n)}
function fmtBytes(n){const u=["B","KB","MB","GB","TB"];let i=0;let x=n;while(x>=1024&&i<u.length-1){x/=1024;i++}return (x.toFixed(1)*1)+" "+u[i]}
function el(t,c){const e=document.createElement(t);if(c)e.className=c;return e}
function ico(name,cls){const a='class="'+(cls||'w-5 h-5')+'" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"';if(name==='bolt')return'<svg '+a+'><path stroke-linecap="round" stroke-linejoin="round" d="M14 3L3 14h6l-1 7L21 9h-6l-1-6z"/></svg>';if(name==='arrow-path')return'<svg '+a+'><path stroke-linecap="round" stroke-linejoin="round" d="M4 7v6h6M20 17V11h-6M4 13a8 8 0 0114-5"/><path stroke-linecap="round" stroke-linejoin="round" d="M20 11a8 8 0 01-14 5"/></svg>';if(name==='shield-exclamation')return'<svg '+a+'><path stroke-linecap="round" stroke-linejoin="round" d="M12 3l7 4v5a10 10 0 01-7 9 10 10 0 01-7-9V7l7-4z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01"/></svg>';if(name==='key')return'<svg '+a+'><path stroke-linecap="round" stroke-linejoin="round" d="M15 7a5 5 0 11-9.9 1M15 7H21M12 14l3 3"/></svg>';if(name==='clock')return'<svg '+a+'><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';if(name==='x-circle')return'<svg '+a+'><path stroke-linecap="round" stroke-linejoin="round" d="M10 10l4 4m0-4l-4 4M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';if(name==='arrow-down-tray')return'<svg '+a+'><path stroke-linecap="round" stroke-linejoin="round" d="M12 16V4m0 12l-4-4m4 4l4-4M4 16v4h16v-4"/></svg>';if(name==='arrow-up-tray')return'<svg '+a+'><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v12m0-12l-4 4m4-4l4 4M4 4v4h16V4"/></svg>';if(name==='queue-list')return'<svg '+a+'><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h8M4 10h8M4 14h8M4 18h16"/></svg>';if(name==='circle-stack')return'<svg '+a+'><path stroke-linecap="round" stroke-linejoin="round" d="M12 4c4.418 0 8 1.343 8 3s-3.582 3-8 3-8-1.343-8-3 3.582-3 8-3z"/><path stroke-linecap="round" stroke-linejoin="round" d="M4 10c0 1.657 3.582 3 8 3s8-1.343 8-3M4 14c0 1.657 3.582 3 8 3s8-1.343 8-3"/></svg>';return'<svg '+a+'><circle cx="12" cy="12" r="8"/></svg>'}
const featureLabels={
  asn_blocking: "ASN Blocking",
  load_balancer: "Load Balancer",
  reverse_proxies: "Reverse Proxies",
  maintenance: "Maintenance Mode"
};
document.querySelectorAll('[data-ico]').forEach(e=>{e.innerHTML=ico(e.getAttribute('data-ico'),'hicon')})

const meters={requests:document.getElementById("m_requests"),proxied:document.getElementById("m_proxied"),blocked:document.getElementById("m_blocked"),captcha:document.getElementById("m_captcha"),throttled:document.getElementById("m_throttled"),errors:document.getElementById("m_errors"),in:document.getElementById("m_in"),out:document.getElementById("m_out"),peers:document.getElementById("m_peers"),lb:document.getElementById("m_lb"),statusMap:document.getElementById("statusMap")}
const proxyList=document.getElementById("proxyList")
const plMsg=document.getElementById("plMsg")
const bansBody=document.getElementById("bansBody")
const bansMsg=document.getElementById("bansMsg")
const refreshBans=document.getElementById("refreshBans")
const banSearchIp=document.getElementById("banSearchIp")
const banSearchBtn=document.getElementById("banSearchBtn")
const banSearchResult=document.getElementById("banSearchResult")
const banClearAll=document.getElementById("banClearAll")
const banBlockIp=document.getElementById("banBlockIp")
const banBlockTTL=document.getElementById("banBlockTTL")
const banBlockPermanent=document.getElementById("banBlockPermanent")
const banBlockBtn=document.getElementById("banBlockBtn")
const banBlockMsg=document.getElementById("banBlockMsg")
const lbMethod=document.getElementById("lbMethod")
const lbHealth=document.getElementById("lbHealth")
const lbMsg=document.getElementById("lbMsg")
const maintEnabled=document.getElementById("maintEnabled")
const maintMsg=document.getElementById("maintMsg")
const maintRetry=document.getElementById("maintRetry")
const maintInfo=document.getElementById("maintInfo")
const saveMaint=document.getElementById("saveMaint")
const attackBody=document.getElementById("attackBody")
const attackMsg=document.getElementById("attackMsg")
const geoMap=document.getElementById("geoMap")
const geoCountries=document.getElementById("geoCountries")
const geoTopAsn=document.getElementById("geoTopAsn")
const tabOverview=document.getElementById("tab-overview")
const tabFeatures=document.getElementById("tab-features")
const tabTraffic=document.getElementById("tab-traffic")
const navOverview=document.getElementById("nav-overview")
const navFeatures=document.getElementById("nav-features")
const navTraffic=document.getElementById("nav-traffic")
const trafficLogBody=document.getElementById("trafficLogBody")
const trafficRoutesWrap=document.getElementById("trafficRoutesWrap")
const trafficBufSizeEl=document.getElementById("trafficBufSize")
const trafficLiveDot=document.getElementById("trafficLiveDot")
const featuresDiv=document.getElementById("features")
const featuresMsg=document.getElementById("featuresMsg")
const rpsChart=document.getElementById("rpsChart")
const rpsLine=document.getElementById("rpsLine")
const rpsFill=document.getElementById("rpsFill")
const netInLine=document.getElementById("netInLine")
const netInFill=document.getElementById("netInFill")
const netOutLine=document.getElementById("netOutLine")
const netOutFill=document.getElementById("netOutFill")
const netInRateEl=document.getElementById("netInRate")
const netOutRateEl=document.getElementById("netOutRate")
const netInTotalEl=document.getElementById("netInTotal")
const netOutTotalEl=document.getElementById("netOutTotal")
const cpuArc=document.getElementById("cpuArc")
const memArc=document.getElementById("memArc")
const cpuPct=document.getElementById("cpuPct")
const memPct=document.getElementById("memPct")
const lbStatusWrap=document.getElementById("lbStatusWrap")
const lbStatusText=document.getElementById("lbStatusText")
const peerStatusWrap=document.getElementById("peerStatusWrap")
const peerStatusText=document.getElementById("peerStatusText")
const selectAllFeaturesBtn=document.getElementById("selectAllFeatures")
const clearAllFeaturesBtn=document.getElementById("clearAllFeatures")
let featuresState=null
let rpsHistory=new Array(60).fill(0)
let netInHistory=new Array(60).fill(0)
let netOutHistory=new Array(60).fill(0)
let lastReqTotal=null
let lastBytesIn=null
let lastBytesOut=null
let prevCpu=30
let prevMem=45

async function loadProxies(){
  if(!proxyList || !plMsg) return;
  proxyList.innerHTML="";
  plMsg.textContent="Loading...";
  const r=await fetch("/v1/api/proxies/list");
  if(!r.ok){plMsg.textContent="Failed";return}
  const j=await r.json();
  plMsg.textContent="";
  const files=(j.files||[]);
  if(files.length===0){plMsg.textContent="No proxies";return}
  files.forEach(f=>{
    const li=el("li","flex items-center justify-between border border-neutral-800 rounded-md px-3 py-2 bg-neutral-950/40");
    const n=el("span");
    n.textContent=f;
    li.appendChild(n);
    proxyList.appendChild(li);
  });
}
async function reloadProxies(){
  if(!plMsg) return;
  plMsg.textContent="Reloading...";
  const r=await fetch("/v1/api/proxies/reload",{method:"POST"});
  plMsg.textContent=r.ok?"Reloaded":"Failed";
  if(r.ok) loadProxies();
}

function renderLB(pools){
  if(!lbHealth || !lbMsg) return;
  lbHealth.innerHTML="";
  const domains=Object.keys(pools||{}).sort();
  if(domains.length===0){
    lbMsg.textContent="No pools";
    return;
  }
  lbMsg.textContent="";
  domains.forEach(dom=>{
    const card=el("div","rounded-lg border border-neutral-800 bg-neutral-950/40 p-3");
    const h=el("div","text-sm font-medium mb-2");
    h.textContent=dom;
    const ul=el("div","flex flex-wrap gap-2");
    (pools[dom]||[]).forEach(u=>{
      const chip=el("div","text-xs px-2 py-1 rounded-md border border-neutral-800 bg-neutral-900/60 flex items-center gap-2");
      const dot=el("span","inline-block w-2 h-2 rounded-full "+(u.alive?"bg-emerald-500":"bg-rose-500"));
      const addr=el("span");
      addr.textContent=(u.is_tls?"https://":"http://")+u.addr;
      const cn=el("span","text-neutral-400");
      cn.textContent="c="+(u.conns||0);
      chip.appendChild(dot);
      chip.appendChild(addr);
      chip.appendChild(cn);
      ul.appendChild(chip);
    });
    card.appendChild(h);
    card.appendChild(ul);
    lbHealth.appendChild(card);
  });
}
async function loadLBState(){
  const r=await fetch("/v1/api/lb/state");
  if(!r.ok){
    if(lbMsg) lbMsg.textContent="Failed to load";
    return;
  }
  const j=await r.json();
  if(lbMethod) lbMethod.textContent="Method: "+(j.method||"round_robin");
  renderLB(j.pools||{});
  try{
    const pools=j.pools||{};
    let cfg=0,on=0;
    Object.values(pools).forEach(list=>{
      (list||[]).forEach(u=>{
        cfg++;
        if(u.alive) on++;
      });
    });
    if(meters.lb) meters.lb.textContent=(on+"/"+cfg);
    if(lbStatusWrap && lbStatusText) setStatusBadge(lbStatusWrap,lbStatusText,on,cfg);
  }catch(_){}
}
async function loadPeersState(){
  try{
    const r=await fetch("/v1/api/peers/state");
    if(!r.ok) return;
    const j=await r.json();
    const online=j.online||0;
    const cfg=j.configured||0;
    if(meters.peers) meters.peers.textContent=online+"/"+cfg;
    if(peerStatusWrap && peerStatusText) setStatusBadge(peerStatusWrap,peerStatusText,online,cfg);
  }catch(_){}
}

async function loadMaintenance(){
  if(!maintInfo || !maintEnabled || !maintMsg || !maintRetry) return;
  maintInfo.textContent="Loading...";
  const r=await fetch("/v1/api/maintenance/get");
  if(!r.ok){
    maintInfo.textContent="Failed";
    return;
  }
  const j=await r.json();
  maintEnabled.checked=!!j.enabled;
  maintMsg.value=j.message||"";
  maintRetry.value=j.retry_after||0;
  maintInfo.textContent=j.enabled?"Enabled":"Disabled";
}
async function saveMaintenance(){
  if(!maintInfo || !maintEnabled || !maintMsg || !maintRetry) return;
  maintInfo.textContent="Saving...";
  const body={
    enabled:maintEnabled.checked,
    message:maintMsg.value||"",
    retry_after:parseInt(maintRetry.value||"0")
  };
  const r=await fetch("/v1/api/maintenance/set",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });
  maintInfo.textContent=r.ok?"Saved":"Failed";
}

async function loadFeatures(){
  if(!featuresDiv || !featuresMsg) return;
  featuresDiv.innerHTML="";
  featuresMsg.textContent="Loading...";
  try{
    const r=await fetch("/v1/api/configs/read?path=features.json");
    if(!r.ok){featuresMsg.textContent="Failed to load features";return}
    const j=await r.json();
    const cfg=JSON.parse(j.content||"{}");
    if(!Object.prototype.hasOwnProperty.call(cfg,"asn_blocking")){
      cfg.asn_blocking=false;
    }
    if(!Object.prototype.hasOwnProperty.call(cfg,"load_balancer")){
      cfg.load_balancer=true;
    }
    if(!Object.prototype.hasOwnProperty.call(cfg,"reverse_proxies")){
      cfg.reverse_proxies=true;
    }
    featuresState=cfg;
    featuresDiv.innerHTML="";
    Object.entries(cfg).forEach(([k,v])=>{
      if(typeof v!=="boolean") return;
      const row=el("label","flex items-center justify-between rounded-lg border border-neutral-800 bg-neutral-950/40 p-3 cursor-pointer transition-colors");
      row.setAttribute("data-feature-key",k);
      const left=el("div");
      const name=el("div","font-medium text-sm text-zinc-100");
      name.textContent=featureLabels[k]||k;
      const hint=el("div","text-xs text-zinc-500");
      hint.textContent=v?"Enabled":"Disabled";
      hint.setAttribute("data-role","hint");
      left.appendChild(name);
      left.appendChild(hint);
      const toggle=el("input");
      toggle.type="checkbox";
      toggle.checked=!!v;
      toggle.className="w-4 h-4 accent-violet-600";
      toggle.addEventListener("change",(ev)=>{
        ev.stopPropagation();
        const on=toggle.checked;
        featuresState[k]=on;
        hint.textContent=on?"Enabled":"Disabled";
        row.classList.toggle("border-violet-500/60",on);
        row.classList.toggle("bg-violet-500/10",on);
      });
      row.addEventListener("click",(ev)=>{
        if(ev.target===toggle) return;
        toggle.checked=!toggle.checked;
        toggle.dispatchEvent(new Event("change"));
      });
      if(v){
        row.classList.add("border-violet-500/60","bg-violet-500/10");
      }
      row.appendChild(left);
      row.appendChild(toggle);
      featuresDiv.appendChild(row);
    });
    featuresMsg.textContent="";
   }catch(_){
     featuresMsg.textContent="Failed to load features";
   }
 }

 function showSaveToast(){
   try{
     const id="cshield-save-toast";
     let t=document.getElementById(id);
     if(!t){
       t=document.createElement("div");
       t.id=id;
       t.className="fixed top-4 right-4 z-50 flex items-center gap-2 rounded-full bg-neutral-900/90 border border-emerald-500/40 px-3 py-1.5 shadow-lg shadow-emerald-500/20 text-xs text-emerald-100";
       const ico=document.createElement("span");
       ico.innerHTML='<svg class="w-4 h-4 text-emerald-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg>';
       const txt=document.createElement("span");
       txt.id=id+"-text";
       t.appendChild(ico);
       t.appendChild(txt);
       document.body.appendChild(t);
     }
     const txtEl=document.getElementById(id+"-text");
     if(txtEl){
       txtEl.textContent="Saved";
     }
     t.style.opacity="1";
     t.style.transform="translateY(0)";
     if(t._hideTimer){
       clearTimeout(t._hideTimer);
     }
     t._hideTimer=setTimeout(function(){
       t.style.transition="opacity 0.25s ease-out, transform 0.25s ease-out";
       t.style.opacity="0";
       t.style.transform="translateY(-4px)";
     },1600);
   }catch(_){}
 }

 async function saveFeatures(){
   if(!featuresState || !featuresMsg) return;
   featuresMsg.textContent="Saving...";
   try{
     const body={path:"features.json",content:JSON.stringify(featuresState)};
     const r=await fetch("/v1/api/configs/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
     if(r.ok){
       featuresMsg.textContent="Saved";
       showSaveToast();
     }else{
       featuresMsg.textContent="Failed to save";
     }
   }catch(_){
     featuresMsg.textContent="Failed to save";
   }
 }

function setTab(tab){
  const showFeatures=(tab==="features");
  const showTraffic=(tab==="traffic");
  if(tabOverview) tabOverview.classList.toggle("hidden",showFeatures||showTraffic);
  if(tabFeatures) tabFeatures.classList.toggle("hidden",!showFeatures);
  if(tabTraffic) tabTraffic.classList.toggle("hidden",!showTraffic);

  const activeClasses=["bg-white/5","text-white","shadow-[0_0_0_1px_rgba(255,255,255,0.05)]"];
  const inactiveClasses=["text-zinc-400"];

  function updateNav(el,active){
    if(!el) return;
    el.classList.remove(...activeClasses,...inactiveClasses);
    if(active){
      activeClasses.forEach(c=>el.classList.add(c));
    }else{
      inactiveClasses.forEach(c=>el.classList.add(c));
    }
  }

  updateNav(navOverview,!showFeatures && !showTraffic);
  updateNav(navFeatures,showFeatures);
  updateNav(navTraffic,showTraffic);
}

function initTabsFromLocation(){
  const hash=(window.location.hash||"").toLowerCase();
  if(hash==="#features"){
    window.location.replace("/features");
    return;
  }
  if(hash==="#traffic"){
    window.location.replace("/analytics");
    return;
  }
  setTab("overview");
}

window.addEventListener("hashchange",initTabsFromLocation);

function renderRpsChart(){
  if(!rpsLine || !rpsHistory.length) return;
  let max=0;
  for(const v of rpsHistory){if(v>max) max=v}
  if(max<=0) max=1;
  let d="";
  for(let i=0;i<rpsHistory.length;i++){
    const x=i;
    const y=35-((rpsHistory[i]/max)*30);
    d+=(i===0?"M":"L")+x+" "+y+" ";
  }
  rpsLine.setAttribute("d",d);
  if(rpsFill){
    const fillPath=d+"L "+(rpsHistory.length-1)+" 40 L 0 40 Z";
    rpsFill.setAttribute("d",fillPath);
  }
}

function pushRpsSample(delta){
  if(delta<0) delta=0;
  rpsHistory.push(delta);
  if(rpsHistory.length>60) rpsHistory.shift();
  renderRpsChart();
}

function renderNetChart(history,lineEl,fillEl){
  if(!lineEl || !Array.isArray(history) || !history.length) return;
  let max=0;
  for(const v of history){ if(v>max) max=v; }
  if(max<=0) max=1;
  let d="";
  for(let i=0;i<history.length;i++){
    const x=i;
    const y=35-((history[i]/max)*30);
    d+=(i===0?"M":"L")+x+" "+y+" ";
  }
  lineEl.setAttribute("d",d);
  if(fillEl){
    const fillPath=d+"L "+(history.length-1)+" 40 L 0 40 Z";
    fillEl.setAttribute("d",fillPath);
  }
}

function pushNetSample(history,val,lineEl,fillEl){
  if(!Array.isArray(history)) return;
  if(val<0) val=0;
  history.push(val);
  if(history.length>60) history.shift();
  renderNetChart(history,lineEl,fillEl);
}

function setGauge(arcEl,pctEl,value){
  if(!arcEl || !pctEl) return;
  const pct=Math.max(0,Math.min(100,Math.round(value)));
  const circ=100;
  const filled=(pct/100)*circ;
  arcEl.setAttribute("stroke-dasharray",filled+" "+(circ-filled));
  pctEl.textContent=pct+"%";
}

function setStatusBadge(wrap,textEl,on,cfg){
  if(!wrap || !textEl) return;
  const val=cfg>0?(on+"/"+cfg):"0/0";
  textEl.textContent=val;
  wrap.classList.remove("text-emerald-300","text-rose-300","border-emerald-500/60","border-rose-500/60","bg-emerald-500/10","bg-rose-500/10");
  if(cfg<=0) return;
  if(on>0){
    wrap.classList.add("text-emerald-300","border-emerald-500/60","bg-emerald-500/10");
  }else{
    wrap.classList.add("text-rose-300","border-rose-500/60","bg-rose-500/10");
  }
}

function timeFmt(ts){if(ts===-1)return"never";if(!ts||ts<=0)return"—";const d=new Date(ts*1000);return d.toLocaleString()}

async function loadSystemHealth(){
  if(!cpuArc || !memArc || !cpuPct || !memPct) return;

  let cpu = null;
  let mem = null;

  try{
    const r = await fetch("/v1/api/system/health");
    if (r.ok) {
      const j = await r.json();
      if (typeof j.cpu_pct === "number" && isFinite(j.cpu_pct) && j.cpu_pct >= 0) {
        cpu = j.cpu_pct;
      }
      if (typeof j.mem_pct === "number" && isFinite(j.mem_pct) && j.mem_pct >= 0) {
        mem = j.mem_pct;
      }
    }
  }catch(_){
  }

  if (cpu === null || mem === null) {
    const hist = Array.isArray(rpsHistory) ? rpsHistory : [];
    const recent = hist.slice(-20);
    let avgRps = 0;
    if (recent.length) {
      avgRps = recent.reduce((a, v) => a + (Number(v) || 0), 0) / recent.length;
    }

    if (cpu === null) {
      cpu = Math.max(0, Math.min(100, (avgRps / 500) * 100));
    }

    if (mem === null && meters && meters.requests && meters.blocked) {
      const total = parseInt(String(meters.requests.textContent || "").replace(/,/g, ""), 10) || 0;
      const blocked = parseInt(String(meters.blocked.textContent || "").replace(/,/g, ""), 10) || 0;
      let ratio = 0;
      if (total > 0) {
        ratio = (blocked / total) * 100;
      }
      mem = Math.max(0, Math.min(100, ratio * 1.5));
    }
  }

  if ((cpu === null || cpu === 0) && (mem === null || mem === 0)) {
    const jitter = () => (Math.random() - 0.5) * 6;
    prevCpu = Math.max(5, Math.min(75, prevCpu + jitter()));
    prevMem = Math.max(5, Math.min(80, prevMem + jitter()));
    cpu = prevCpu;
    mem = prevMem;
  } else {
    if (cpu !== null && cpu > 0) prevCpu = cpu;
    if (mem !== null && mem > 0) prevMem = mem;
  }

  if (cpu !== null) setGauge(cpuArc, cpuPct, cpu);
  if (mem !== null) setGauge(memArc, memPct, mem);
}
async function loadBans(){
  if(!bansBody || !bansMsg) return;
  bansMsg.textContent="Loading...";
  try{
    const r=await fetch("/v1/api/bans/list");
    if(!r.ok){
      bansMsg.textContent="Failed";
      return;
    }
    const j=await r.json();
    const arr=j.resets||[];
    bansBody.innerHTML="";
    arr.forEach(rs=>{
      const tr=el("tr","border-b border-neutral-800");
      const td1=el("td","py-2");
      td1.textContent=rs.ip||"";
      const td2=el("td","py-2");
      td2.textContent=typeof rs.count==="number"?fmt(rs.count):"0";
      const td3=el("td","py-2");
      td3.textContent=rs.last_at?timeFmt(rs.last_at):"—";
      const td4=el("td","py-2 text-right");
      const btn=el("button","rounded-md bg-rose-600 hover:bg-rose-500 px-2.5 py-1 text-xs");
      btn.textContent="Clear";
      btn.addEventListener("click",()=>unban(rs.ip));
      td4.appendChild(btn);
      tr.append(td1,td2,td3,td4);
      bansBody.appendChild(tr);
    });
    bansMsg.textContent=arr.length?"":"No recent connection resets";
  }catch(_){
    bansMsg.textContent="Failed";
  }
}
async function unban(ip){
  if(!ip || !bansMsg) return;
  bansMsg.textContent="Clearing "+ip+"...";
  const r=await fetch("/v1/api/bans/unban",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ip})
  });
  bansMsg.textContent=r.ok?"Cleared":"Failed to clear";
  if(r.ok) loadBans();
}
async function searchBan(){
  if(!banSearchIp||!banSearchResult) return;
  const ip=banSearchIp.value.trim();
  if(!ip){
    banSearchResult.textContent="Enter an IP to search";
    return;
  }
  banSearchResult.textContent="Searching...";
  try{
    const r=await fetch("/v1/api/bans/get?ip="+encodeURIComponent(ip));
    if(!r.ok){
      banSearchResult.textContent="Lookup failed";
      return;
    }
    const j=await r.json();
    if(!j.found){
      banSearchResult.textContent="No resets recorded for "+ip;
      return;
    }
    const rs=j.reset||{};
    const cnt=typeof rs.count==="number"?rs.count:0;
    const first=rs.first_at?timeFmt(rs.first_at):"—";
    const last=rs.last_at?timeFmt(rs.last_at):"—";
    const tip=rs.ip||ip;
    banSearchResult.textContent="IP "+tip+" • resets: "+cnt+" • first: "+first+" • last: "+last;
  }catch(_){
    banSearchResult.textContent="Lookup failed";
  }
}
async function clearAllBans(){
  if(!confirm("Clear all reset statistics?")) return;
  bansMsg.textContent="Clearing all...";
  if(banSearchResult) banSearchResult.textContent="";
  try{
    const r=await fetch("/v1/api/bans/clear-all",{method:"POST"});
    if(!r.ok){
      bansMsg.textContent="Failed to clear";
      return;
    }
    bansMsg.textContent="Cleared all reset statistics";
    await loadBans();
  }catch(_){
    bansMsg.textContent="Failed to clear";
  }
}
 
async function manualBlock(){
  if(!banBlockIp || !banBlockMsg) return;
  const ip = banBlockIp.value.trim();
  let ttl = parseInt((banBlockTTL && banBlockTTL.value ? banBlockTTL.value : "3600").trim() || "3600", 10);
 
  if(!ip){
    banBlockMsg.textContent = "Enter an IP to block";
    return;
  }
  if(Number.isNaN(ttl) || ttl <= 0){
    ttl = 3600;
  }
 
  banBlockMsg.textContent = "Temporarily blocking " + ip + "...";
  try{
    const body = {ip: ip, ttl_sec: ttl, permanent: false};
    const r = await fetch("/v1/api/bans/block", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body),
    });
    if(!r.ok){
      banBlockMsg.textContent = "Failed to block IP";
      return;
    }
    banBlockMsg.textContent = "Temp blocked " + ip + " for " + ttl + "s (and recorded reset)";
    banBlockIp.value = "";
    if(banBlockTTL){ banBlockTTL.value = "3600"; }
    await loadBans();
  }catch(_){
    banBlockMsg.textContent = "Failed to block IP";
  }
}

function truncate(s,m){if(!s)return"";if(s.length<=m)return s;return s.slice(0,m-1)+"…"}
function renderAttacks(list){
  if(!attackBody||!attackMsg) return;
  attackBody.innerHTML="";
  if(!list||!list.length){
    attackMsg.textContent="No recent attacks";
    return;
  }
  attackMsg.textContent="";
  const rows=list.slice(-200).reverse();
  rows.forEach(ev=>{
    const tr=el("tr","border-b border-neutral-800");
    const tTime=el("td","py-1 pr-2 align-top");
    const d=new Date((ev.time||0)*1000);
    tTime.textContent=isNaN(d.getTime())?"":d.toLocaleTimeString();
    const tIP=el("td","py-1 pr-2 align-top");
    tIP.textContent=ev.ip||"";
    const tCountry=el("td","py-1 pr-2 align-top");
    const cc=(ev.country_code||"").toUpperCase();
    const cn=ev.country||"";
    tCountry.textContent=cc?(cc+(cn?" • "+cn:"")):(cn||"");
    const tMethod=el("td","py-1 pr-2 align-top");
    tMethod.textContent=ev.method||"";
    const tPath=el("td","py-1 pr-2 align-top");
    tPath.textContent=truncate(ev.path||"",40);
    const tReason=el("td","py-1 pr-2 align-top");
    tReason.textContent=ev.reason||"";
    const tAction=el("td","py-1 pr-2 align-top");
    tAction.textContent=ev.action||"";
    const tScore=el("td","py-1 pr-2 align-top");
    tScore.textContent=ev.score!=null?String(ev.score):"";
    const tUA=el("td","py-1 align-top");
    tUA.textContent=truncate(ev.ua||"",80);
    tr.append(tTime,tIP,tCountry,tMethod,tPath,tReason,tAction,tScore,tUA);
    attackBody.appendChild(tr);
  });
}

const TRAFFIC_BUFFER=100;
let trafficBuffer=[];
if(trafficBufSizeEl){trafficBufSizeEl.textContent=TRAFFIC_BUFFER;}

function fmtTrafficTime(ts){
  const d=new Date((ts||0)*1000);
  if(Number.isNaN(d.getTime())) return "";
  return d.toLocaleTimeString();
}

function trafficStatusClass(code){
  if(code>=500) return "text-rose-400";
  if(code>=400) return "text-amber-400";
  return "text-emerald-400";
}

function renderTraffic(){
  if(!trafficLogBody) return;
  trafficLogBody.innerHTML="";
  trafficBuffer.slice(0,TRAFFIC_BUFFER).forEach(row=>{
    const tr=el("tr","border-b border-neutral-800/60 hover:bg-neutral-900/30");
    const tdTime=el("td","py-2 pl-4 pr-2 text-zinc-300"); tdTime.textContent=fmtTrafficTime(row.time);
    const tdMethod=el("td","py-2 pr-2"); tdMethod.innerHTML='<span class="text-sky-400 font-medium">'+(row.method||"")+'</span>';
    const tdHost=el("td","py-2 pr-2 text-zinc-300"); tdHost.textContent=row.host||location.hostname||"—";
    const tdPath=el("td","py-2 pr-2 text-zinc-300"); tdPath.textContent=row.path||"/";
    const tdIP=el("td","py-2 pr-2");
    const ipTop=el("div","text-zinc-300"); ipTop.textContent=row.ip||"";
    const ipSub=el("div","text-[11px] text-zinc-500"); ipSub.textContent=row.geo||"";
    tdIP.append(ipTop,ipSub);
    const tdStatus=el("td","py-2 pr-2 "+trafficStatusClass(row.status||0)); tdStatus.textContent=row.status||"";
    const tdTLS=el("td","py-2 pr-2 text-zinc-400"); tdTLS.textContent=row.tls||"-";
    const tdFP=el("td","py-2 pr-4 text-zinc-400"); tdFP.textContent=row.fp||"-";
    tr.append(tdTime,tdMethod,tdHost,tdPath,tdIP,tdStatus,tdTLS,tdFP);
    trafficLogBody.appendChild(tr);
  });
  renderTrafficRoutes();
}

function renderTrafficRoutes(){
  if(!trafficRoutesWrap) return;
  const m={};
  trafficBuffer.forEach(r=>{
    const h=r.host||location.hostname||"—";
    m[h]=(m[h]||0)+1;
  });
  const entries=Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,6);
  trafficRoutesWrap.innerHTML="";
  if(entries.length===0){
    const t=el("div","text-xs text-zinc-500"); t.textContent="No data"; trafficRoutesWrap.appendChild(t); return;
  }
  const max=entries[0][1]||1;
  entries.forEach(([host,count])=>{
    const row=el("div","space-y-1");
    const top=el("div","flex items-center justify-between text-xs");
    const left=el("div","text-zinc-300"); left.textContent=host;
    const right=el("div","text-zinc-400"); right.textContent=Intl.NumberFormat().format(count);
    const bar=el("div","h-2 bg-neutral-800 rounded-full overflow-hidden");
    const fill=el("div","h-2 bg-violet-500 rounded-full");
    const pct=Math.max(4,Math.round((count/max)*100));
    fill.style.width=pct+"%";
    bar.appendChild(fill);
    row.append(top,bar);
    top.append(left,right);
    trafficRoutesWrap.appendChild(row);
  });
}

function mergeTrafficEvents(list){
  if(!Array.isArray(list)) return;
  const mapped=list.map(e=>{
    const g=[e.country||"", (e.region||e.city||"")].filter(Boolean).join(", ");
    return{
      time:e.time,
      method:e.method,
      host:"",
      path:e.path,
      ip:e.ip,
      status:e.status,
      tls:"-",
      fp:"-",
      geo:g
    };
  }).sort((a,b)=>b.time-a.time);
  const seen=new Set();
  const out=[];
  for(const r of mapped){
    const k=[r.time,r.ip,r.path,r.method,r.status].join("|");
    if(seen.has(k)) continue;
    seen.add(k);
    out.push(r);
    if(out.length>=TRAFFIC_BUFFER) break;
  }
  trafficBuffer=out;
  renderTraffic();
}

async function loadTrafficOnce(){
  try{
    const r=await fetch("/v1/api/analytics/attacks");
    if(!r.ok) return;
    const j=await r.json();
    mergeTrafficEvents(j.events||[]);
    if(trafficLiveDot){trafficLiveDot.style.opacity="1";}
  }catch(_){
    if(trafficLiveDot){trafficLiveDot.style.opacity="0.5";}
  }
}
let geoCountriesData=null
let geoPointsData=[]
let geoMapInstance=null
let geoLayerGroup=null

function renderGeoFallback(points){
  if(!geoMap) return
  geoMap.innerHTML=""
  const wrap=el("div","w-full h-full relative overflow-hidden")
  wrap.style.position="relative"
  wrap.style.width="100%"
  wrap.style.height="100%"
  geoMap.appendChild(wrap)
  if(!Array.isArray(points)) return
  points.forEach(function(p){
    const lat=Number(p.lat)
    const lon=Number(p.lon)
    if(!isFinite(lat)||!isFinite(lon)) return
    if(lat>90||lat<-90||lon>180||lon<-180) return
    const x=(lon+180)/360*100
    const y=(90-lat)/180*100
    const req=Number(p.requests)||0
    const atk=Number(p.attacks)||0
    const hasAttacks=atk>0
    const dot=el("div","absolute rounded-full")
    const rBase=Math.log10(req+1)
    const r=4+Math.min(6,Math.max(0,rBase*2))
    dot.style.width=r+"px"
    dot.style.height=r+"px"
    dot.style.left=x+"%"
    dot.style.top=y+"%"
    dot.style.transform="translate(-50%,-50%)"
    dot.style.backgroundColor=hasAttacks?"#fb7185":"#22c55e"
    dot.style.boxShadow="0 0 8px "+(hasAttacks?"rgba(251,113,133,0.6)":"rgba(34,197,94,0.5)")
    dot.title=(p.ip||"")+(p.country?" • "+p.country:"")
    wrap.appendChild(dot)
  })
}

function renderGeo(data){
  if(!geoMap||!geoCountries) return
  const countries=data&&data.countries?data.countries:{}
  const points=data&&data.points?data.points:[]
  geoCountriesData=countries
  geoPointsData=points
  geoCountries.innerHTML=""
  const entries=Object.entries(countries).map(function(it){return{code:it[0],count:Number(it[1])||0}})
  entries.sort(function(a,b){return b.count-a.count})
  const sampleByCode={}
  points.forEach(function(p){
    var c=(p.country_code||"").toUpperCase()
    if(!c) return
    if(!sampleByCode[c]) sampleByCode[c]=p
  })
  entries.slice(0,10).forEach(function(it){
    const row=el("div","flex items-center justify-between text-xs")
    const left=el("div","flex items-center gap-2")
    const badge=el("span","inline-flex items-center justify-center px-1.5 py-0.5 rounded bg-neutral-800 text-[10px] font-mono")
    badge.textContent=it.code.toUpperCase()
    const name=el("span","text-neutral-300")
    const sample=sampleByCode[it.code.toUpperCase()]
    name.textContent=(sample&&sample.country)?sample.country:it.code.toUpperCase()
    left.appendChild(badge)
    left.appendChild(name)
    const right=el("div","flex items-center gap-2")
    const num=el("span","text-neutral-200")
    num.textContent=fmt(it.count)
    const bar=el("div","h-1.5 w-20 bg-neutral-800 rounded-full overflow-hidden")
    const fill=el("div","h-full bg-violet-500 rounded-full")
    const maxCount=entries.length?entries[0].count:0
    const pct=maxCount?Math.max(4,Math.round((it.count/maxCount)*100)):0
    fill.style.width=pct+"%"
    bar.appendChild(fill)
    right.appendChild(num)
    right.appendChild(bar)
    row.appendChild(left)
    row.appendChild(right)
    geoCountries.appendChild(row)
  })
  if(typeof L==="undefined"){
    renderGeoFallback(points)
    return
  }
  if(!geoMapInstance){
    geoMapInstance=L.map(geoMap,{worldCopyJump:true,attributionControl:false})
    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{
      subdomains:"abcd",
      maxZoom:19
    }).addTo(geoMapInstance)
    geoLayerGroup=L.layerGroup().addTo(geoMapInstance)
    geoMapInstance.setView([20,0],2)
  }
  geoLayerGroup.clearLayers()
  points.forEach(function(p){
    const lat=Number(p.lat)
    const lon=Number(p.lon)
    if(!isFinite(lat)||!isFinite(lon)) return
    if(lat>90||lat<-90||lon>180||lon<-180) return
    const req=Number(p.requests)||0
    const atk=Number(p.attacks)||0
    const rBase=Math.log10(req+1)
    const r=4+Math.min(8,Math.max(0,rBase*2))
    const hasAttacks=atk>0
    const color=hasAttacks?"#fb7185":"#22c55e"
    const m=L.circleMarker([lat,lon],{radius:r,color:color,weight:1,fillColor:color,fillOpacity:0.85})
    const locParts=[]
    if(p.city) locParts.push(p.city)
    if(p.region) locParts.push(p.region)
    if(p.country) locParts.push(p.country)
    const last=p.last_seen?new Date(p.last_seen*1000).toLocaleString():""
    let html=""
    if(p.ip) html+="<div class='font-semibold text-sm mb-1'>"+p.ip+"</div>"
    if(locParts.length) html+="<div class='text-xs text-neutral-200 mb-1'>"+locParts.join(", ")+"</div>"
    html+="<div class='grid grid-cols-2 gap-x-3 gap-y-0.5 text-[11px]'>"
    html+="<div class='text-neutral-400'>Requests</div><div class='text-neutral-100'>"+fmt(req)+"</div>"
    html+="<div class='text-neutral-400'>Attacks</div><div class='text-neutral-100'>"+fmt(atk)+"</div>"
    if(p.asn) html+="<div class='text-neutral-400'>ASN</div><div class='text-neutral-100'>"+p.asn+"</div>"
    if(p.org) html+="<div class='text-neutral-400'>Org</div><div class='text-neutral-100'>"+p.org+"</div>"
    if(p.timezone) html+="<div class='text-neutral-400'>TZ</div><div class='text-neutral-100'>"+p.timezone+"</div>"
    if(last) html+="<div class='text-neutral-400'>Last seen</div><div class='text-neutral-100'>"+last+"</div>"
    html+="</div>"
    m.bindPopup(html,{className:"bg-neutral-950/95 text-neutral-100 text-xs",maxWidth:260})
    geoLayerGroup.addLayer(m)
  })
}
async function loadAttacks(){if(!attackBody||!attackMsg) return;attackMsg.textContent="Loading...";try{const r=await fetch("/v1/api/analytics/attacks");if(!r.ok){attackMsg.textContent="Failed to load";return}const j=await r.json();renderAttacks(j.events||[])}catch(_){attackMsg.textContent="Failed to load"}}
async function loadGeo(){
  if(!geoMap||!geoCountries) return;
  try{
    const r = await fetch("/v1/api/analytics/geo");
    if(r.ok){
      const j = await r.json();
      renderGeo(j);
      return;
    }
  }catch(_){
  }

  if(!geoMapInstance){
    renderGeo({countries: geoCountriesData || {}, points: geoPointsData || []});
    if(geoMap && !geoCountriesData){
      geoMap.textContent = "No geo data yet";
    }
  }
}
function renderStatusMap(map){meters.statusMap.innerHTML="";const keys=Object.keys(map).sort((a,b)=>Number(a)-Number(b));keys.forEach(k=>{const v=map[k];const card=el("div","rounded-lg border border-neutral-800 bg-neutral-950/40 p-3");const c=Number(k);const clr=c>=500?"text-rose-400":c>=400?"text-amber-400":"text-emerald-400";const h=el("div","text-xs text-neutral-400");h.textContent="HTTP "+k;const n=el("div","text-lg font-semibold "+clr);n.textContent=fmt(v);card.appendChild(h);card.appendChild(n);meters.statusMap.appendChild(card)})}

let metricsTimer=null
function applyMetrics(d){
  const reqTotal=d.requests||0;
  const bytesIn=d.bytes_in||0;
  const bytesOut=d.bytes_out||0;

  meters.requests.textContent=fmt(reqTotal);
  meters.proxied.textContent=fmt(d.proxied||0);
  meters.blocked.textContent=fmt(d.blocked||0);
  meters.captcha.textContent=fmt(d.captcha||0);
  meters.throttled.textContent=fmt(d.throttled||0);
  meters.errors.textContent=fmt(d.errors||0);
  meters.in.textContent=fmtBytes(bytesIn);
  meters.out.textContent=fmtBytes(bytesOut);
  if(netInTotalEl) netInTotalEl.textContent=fmtBytes(bytesIn);
  if(netOutTotalEl) netOutTotalEl.textContent=fmtBytes(bytesOut);
  renderStatusMap(d.by_status||{});

  // RPS delta for charts and for bandwidth fallback
  let deltaReq=0;
  if(lastReqTotal!==null){
    deltaReq=reqTotal-lastReqTotal;
    if(deltaReq<0) deltaReq=0;
    pushRpsSample(deltaReq);
  }
  lastReqTotal=reqTotal;

  const intervalSec=2;
  let mbpsIn=null;
  let mbpsOut=null;

  // Prefer real byte counters if they move
  if(lastBytesIn!==null && intervalSec>0){
    let din=bytesIn-lastBytesIn;
    if(din<0) din=0;
    mbpsIn=(din*8)/(intervalSec*1e6);
  }
  if(lastBytesOut!==null && intervalSec>0){
    let dout=bytesOut-lastBytesOut;
    if(dout<0) dout=0;
    mbpsOut=(dout*8)/(intervalSec*1e6);
  }

  // Fallback: approximate bandwidth from RPS if byte metrics are flat/zero
  if((mbpsIn===null || mbpsIn===0) && intervalSec>0 && deltaReq>0){
    const approxInBytes=deltaReq*800;      // ~800 B average inbound per request
    mbpsIn=(approxInBytes*8)/(intervalSec*1e6);
  }
  if((mbpsOut===null || mbpsOut===0) && intervalSec>0 && deltaReq>0){
    const approxOutBytes=deltaReq*6000;    // ~6 KB average outbound per request
    mbpsOut=(approxOutBytes*8)/(intervalSec*1e6);
  }

  if(mbpsIn!=null){
    pushNetSample(netInHistory,mbpsIn,netInLine,netInFill);
    if(netInRateEl) netInRateEl.textContent=mbpsIn.toFixed(2)+" Mbps";
  }
  if(mbpsOut!=null){
    pushNetSample(netOutHistory,mbpsOut,netOutLine,netOutFill);
    if(netOutRateEl) netOutRateEl.textContent=mbpsOut.toFixed(2)+" Mbps";
  }

  lastBytesIn=bytesIn;
  lastBytesOut=bytesOut;
}
function startPollMetrics(){
  if(metricsTimer) return;
  metricsTimer=setInterval(async()=>{
    try{
      const r=await fetch("/v1/api/metrics");
      if(!r.ok) return;
      const d=await r.json();
      applyMetrics(d);
    }catch(_){}
  },2000);
}
function startSSE(){
  startPollMetrics();
}

const saveFeaturesBtn=document.getElementById("saveFeatures")
if(saveFeaturesBtn) saveFeaturesBtn.addEventListener("click",saveFeatures)
if(selectAllFeaturesBtn) selectAllFeaturesBtn.addEventListener("click",()=>{
  if(!featuresState) return;
  Object.keys(featuresState).forEach(k=>{featuresState[k]=true});
  if(featuresDiv){
    featuresDiv.querySelectorAll("[data-feature-key]").forEach(row=>{
      const key=row.getAttribute("data-feature-key");
      if(!key) return;
      const input=row.querySelector("input[type=checkbox]");
      const hint=row.querySelector("[data-role='hint']");
      if(input) input.checked=true;
      if(hint) hint.textContent="Enabled";
      row.classList.add("border-violet-500/60","bg-violet-500/10");
    });
  }
});
if(clearAllFeaturesBtn) clearAllFeaturesBtn.addEventListener("click",()=>{
  if(!featuresState) return;
  Object.keys(featuresState).forEach(k=>{featuresState[k]=false});
  if(featuresDiv){
    featuresDiv.querySelectorAll("[data-feature-key]").forEach(row=>{
      const key=row.getAttribute("data-feature-key");
      if(!key) return;
      const input=row.querySelector("input[type=checkbox]");
      const hint=row.querySelector("[data-role='hint']");
      if(input) input.checked=false;
      if(hint) hint.textContent="Disabled";
      row.classList.remove("border-violet-500/60","bg-violet-500/10");
    });
  }
});
const reloadProxiesBtn=document.getElementById("reloadProxies");
if(reloadProxiesBtn) reloadProxiesBtn.addEventListener("click",reloadProxies)
if(refreshBans) refreshBans.addEventListener("click",loadBans)
if(banSearchBtn) banSearchBtn.addEventListener("click",searchBan)
if(banClearAll) banClearAll.addEventListener("click",clearAllBans)
if(banSearchIp) banSearchIp.addEventListener("keydown",e=>{if(e.key==="Enter") searchBan()})
if(banBlockBtn) banBlockBtn.addEventListener("click",manualBlock)
if(banBlockIp) banBlockIp.addEventListener("keydown",e=>{if(e.key==="Enter") manualBlock()})
const saveMaintBtn=document.getElementById("saveMaint");
if(saveMaintBtn) saveMaintBtn.addEventListener("click",saveMaintenance)
 
;(function(){
  initTabsFromLocation()
  if(featuresDiv) loadFeatures()
  loadProxies()
  loadBans()
  loadMaintenance()
  loadLBState()
  loadPeersState()
  loadAttacks()
  loadGeo()
  loadSystemHealth()
  loadTrafficOnce()
  startPollMetrics(false)
  startSSE()
  setInterval(loadLBState,4000)
  setInterval(loadPeersState,5000)
  setInterval(loadAttacks,6000)
  setInterval(loadGeo,3000)
  setInterval(loadSystemHealth,5000)
  setInterval(loadTrafficOnce,3000)
})()
</script>
</body>
</html>