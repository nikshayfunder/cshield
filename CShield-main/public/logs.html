<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CShield • Live Logs</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@keyframes floatUp{0%{transform:translateY(6px);opacity:.0}100%{transform:translateY(0);opacity:1}}
@keyframes pulseDot{0%,100%{opacity:1}50%{opacity:.25}}
.animate-float{animation:floatUp .5s ease-out both}
.card{backdrop-filter:blur(6px)}
.scroll-thin::-webkit-scrollbar{height:6px;width:6px}
.scroll-thin::-webkit-scrollbar-thumb{background:#27272a;border-radius:9999px}
.badge{display:inline-flex;align-items:center;gap:.35rem;padding:.28rem .6rem;border-radius:.6rem;border:1px solid rgba(64,64,64,.6);background:rgba(10,10,12,.6);font-size:.7rem}
.dot{width:8px;height:8px;border-radius:9999px;display:inline-block}
</style>
</head>
<body class="min-h-screen bg-neutral-950 text-neutral-100 selection:bg-violet-600/30 selection:text-neutral-50">

<header class="border-b border-neutral-900/80 bg-neutral-950/60 sticky top-0 z-40">
  <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
    <a href="/dashboard" class="group flex items-center gap-3">
      <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-violet-500 to-fuchsia-600 shadow-lg shadow-violet-800/20 group-hover:scale-105 transition-transform"></div>
      <div class="leading-tight">
        <div class="font-semibold -mb-0.5">CShield</div>
        <div class="text-[11px] text-neutral-400">Edge Security Suite</div>
      </div>
    </a>
    <nav class="flex items-center gap-2 text-sm">
      <a class="px-3 py-1.5 rounded-md hover:bg-neutral-900 transition inline-flex items-center gap-2 text-neutral-300" href="/dashboard" title="Dashboard">
        <svg width="16" height="16" viewBox="0 0 24 24" class="opacity-80"><path fill="currentColor" d="M10 3.5L3 9v11h6v-7h6v7h6V9l-7-5.5z"/></svg>
        Dashboard
      </a>
      <a class="px-3 py-1.5 rounded-md hover:bg-neutral-900 transition inline-flex items-center gap-2 text-neutral-300" href="/settings" title="Settings">
        <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M12 8a4 4 0 1 0 .001 8.001A4 4 0 0 0 12 8zm8.94 4a7.96 7.96 0 0 0-.16-1.61l2.07-1.62l-2-3.46l-2.49 1a8.24 8.24 0 0 0-2.79-1.62l-.42-2.65H9.85l-.42 2.65a8.24 8.24 0 0 0-2.79 1.62l-2.49-1l-2 3.46l2.07 1.62A7.96 7.96 0 0 0 3.06 12c0 .55.06 1.09.16 1.61L1.15 15.23l2 3.46l2.49-1a8.24 8.24 0 0 0 2.79 1.62l.42 2.65h4.31l.42-2.65a8.24 8.24 0 0 0 2.79-1.62l2.49 1l2-3.46l-2.07-1.62c.1-.52.16-1.06.16-1.61z"/></svg>
        Settings
      </a>
      <a class="px-3 py-1.5 rounded-md hover:bg-neutral-900 transition inline-flex items-center gap-2 text-neutral-300" href="/add_proxy" title="Add Proxy">
        <svg width="16" height="16" viewBox="0 0 24 24" class="opacity-80"><path fill="currentColor" d="M10 17v-4H6v-2h4V7h2v4h4v2h-4v4z"/></svg>
        Add Proxy
      </a>
      <a class="px-3 py-1.5 rounded-md hover:bg-neutral-900 transition inline-flex items-center gap-2 text-neutral-300" href="/proxies" title="Proxies">
        <svg width="16" height="16" viewBox="0 0 24 24" class="opacity-80"><path fill="currentColor" d="M3 5h18v4H3V5zm0 5h18v9H3v-9zm2 2v5h14v-5H5z"/></svg>
        Proxies
      </a>
      <span class="px-3 py-1.5 rounded-md bg-neutral-900 text-white inline-flex items-center gap-2" title="Logs">
        <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M4 5h16v2H4V5zm0 4h10v2H4V9zm0 4h16v2H4v-2zm0 4h10v2H4v-2z"/></svg>
        Logs
      </span>
    </nav>
  </div>
</header>
<div class="h-[2px] bg-gradient-to-r from-violet-600 via-fuchsia-500 to-indigo-500 opacity-70"></div>

<main class="mx-auto max-w-7xl px-4 py-8 space-y-6">

  <section class="rounded-xl border border-neutral-900/80 bg-neutral-900/50 card p-0 overflow-hidden">
    <div class="px-4 py-3 border-b border-neutral-900 flex items-center justify-between">
      <div class="text-lg font-semibold inline-flex items-center gap-2">
        Live Traffic Log
        <span class="dot bg-emerald-500 animate-[pulseDot_1.8s_ease-in-out_infinite]" id="liveDot"></span>
      </div>
      <div class="text-xs text-neutral-400">Buffer: <span id="bufSize">100</span> recent requests</div>
    </div>

    <div class="overflow-auto scroll-thin">
      <table class="w-full text-xs">
        <thead class="bg-neutral-950/60 text-neutral-400">
          <tr class="border-b border-neutral-900">
            <th class="text-left font-medium py-2 pl-4 pr-2">Time</th>
            <th class="text-left font-medium py-2 pr-2">Method</th>
            <th class="text-left font-medium py-2 pr-2">Host</th>
            <th class="text-left font-medium py-2 pr-2">Path</th>
            <th class="text-left font-medium py-2 pr-2">IP</th>
            <th class="text-left font-medium py-2 pr-2">Status</th>
            <th class="text-left font-medium py-2 pr-2">TLS</th>
            <th class="text-left font-medium py-2 pr-4">FP</th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>
  </section>

  <section class="rounded-xl border border-neutral-900/80 bg-neutral-900/50 card p-6">
    <div class="flex items-center justify-between mb-3">
      <div>
        <div class="text-base font-semibold">Route Analytics</div>
        <div class="text-xs text-neutral-400">Traffic distribution by hostname</div>
      </div>
      <div class="h-6 w-6 rounded-md bg-neutral-800 grid place-items-center">
        <svg width="14" height="14" viewBox="0 0 24 24" class="text-emerald-400"><path fill="currentColor" d="M3 17h2v2H3v-2m0-6h2v4H3v-4m0-6h2v4H3V5m4 8h2v6H7v-6m0-8h2v6H7V5m4 4h2v10h-2V9m0-4h2v2h-2V5m4 10h2v4h-2v-4m0-10h2v8h-2V5"/></svg>
      </div>
    </div>
    <div id="routesWrap" class="space-y-2"></div>
  </section>

</main>

<div class="fixed inset-x-0 bottom-0 h-[1px] bg-gradient-to-r from-fuchsia-500 via-violet-600 to-indigo-500 opacity-70"></div>

<script>
const logBody = document.getElementById("logBody");
const liveDot = document.getElementById("liveDot");
const routesWrap = document.getElementById("routesWrap");
const bufSizeEl = document.getElementById("bufSize");

const BUFFER = 100;
bufSizeEl.textContent = BUFFER;

let buffer = [];

function fmtTime(ts){
  const d = new Date((ts||0)*1000);
  if(Number.isNaN(d.getTime())) return "";
  return d.toLocaleTimeString();
}
function colorStatus(code){
  if(code >= 500) return "text-rose-400";
  if(code >= 400) return "text-amber-400";
  return "text-emerald-400";
}
function el(tag,cls){const e=document.createElement(tag);if(cls)e.className=cls;return e}

function render(){
  if(!logBody) return;
  logBody.innerHTML = "";
  buffer.slice(0, BUFFER).forEach(row=>{
    const tr = el("tr","border-b border-neutral-900/60 hover:bg-neutral-900/30");
    const tdTime = el("td","py-2 pl-4 pr-2 text-neutral-300"); tdTime.textContent = fmtTime(row.time);
    const tdMethod = el("td","py-2 pr-2"); tdMethod.innerHTML = '<span class="text-sky-400 font-medium">'+(row.method||"")+'</span>';
    const tdHost = el("td","py-2 pr-2 text-neutral-300"); tdHost.textContent = row.host || location.hostname || "—";
    const tdPath = el("td","py-2 pr-2 text-neutral-300"); tdPath.textContent = row.path || "/";
    const tdIP = el("td","py-2 pr-2");
    const ipTop = el("div","text-neutral-300"); ipTop.textContent = row.ip || "";
    const ipSub = el("div","text-[11px] text-neutral-500"); ipSub.textContent = row.geo || "";
    tdIP.append(ipTop, ipSub);
    const tdStatus = el("td","py-2 pr-2 "+colorStatus(row.status||0)); tdStatus.textContent = row.status || "";
    const tdTLS = el("td","py-2 pr-2 text-neutral-400"); tdTLS.textContent = row.tls || "-";
    const tdFP = el("td","py-2 pr-4 text-neutral-400"); tdFP.textContent = row.fp || "-";
    tr.append(tdTime,tdMethod,tdHost,tdPath,tdIP,tdStatus,tdTLS,tdFP);
    logBody.appendChild(tr);
  });
  renderRoutes();
}

function renderRoutes(){
  if(!routesWrap) return;
  const m = {};
  buffer.forEach(r=>{
    const h = r.host || location.hostname || "—";
    m[h] = (m[h]||0)+1;
  });
  const entries = Object.entries(m).sort((a,b)=>b[1]-a[1]).slice(0,6);
  routesWrap.innerHTML = "";
  if(entries.length === 0){
    const t = el("div","text-xs text-neutral-400"); t.textContent = "No data"; routesWrap.appendChild(t); return;
  }
  const max = entries[0][1] || 1;
  entries.forEach(([host,count])=>{
    const row = el("div","space-y-1");
    const top = el("div","flex items-center justify-between text-xs");
    const left = el("div","text-neutral-300"); left.textContent = host;
    const right = el("div","text-neutral-400"); right.textContent = Intl.NumberFormat().format(count);
    const bar = el("div","h-2 bg-neutral-800 rounded-full overflow-hidden");
    const fill = el("div","h-2 bg-violet-500 rounded-full");
    const pct = Math.max(4, Math.round((count/max)*100));
    fill.style.width = pct + "%";
    bar.appendChild(fill);
    row.append(top, bar);
    top.append(left,right);
    routesWrap.appendChild(row);
  });
}

function mergeEvents(list){
  if(!Array.isArray(list)) return;
  const mapped = list.map(e=>{
    const g = [e.country||"", (e.region||e.city||"")].filter(Boolean).join(", ");
    return {
      time: e.time,
      method: e.method,
      host: "",    // not provided; fallback to window host
      path: e.path,
      ip: e.ip,
      status: e.status,
      tls: "-",    // not provided
      fp: "-",     // not provided
      geo: g
    };
  }).sort((a,b)=>b.time - a.time);
  const seen = new Set();
  const out = [];
  for(const r of mapped){
    const k = [r.time,r.ip,r.path,r.method,r.status].join("|");
    if(seen.has(k)) continue;
    seen.add(k);
    out.push(r);
    if(out.length >= BUFFER) break;
  }
  buffer = out;
  render();
}

async function loadOnce(){
  try{
    const r = await fetch("/v1/api/analytics/attacks");
    if(!r.ok) return;
    const j = await r.json();
    mergeEvents(j.events || []);
  }catch(_){}
}

function startLive(){
  try{
    const es = new EventSource("/sse/metrics");
    es.addEventListener("metrics", ()=>{ if(liveDot) liveDot.style.opacity = "1"; });
    es.addEventListener("error", ()=>{ try{es.close()}catch(_){}; if(liveDot) liveDot.style.opacity = ".4"; });
  }catch(_){}
}

(async()=>{
  await loadOnce();
  startLive();
  setInterval(loadOnce, 3000);
})();
</script>
</body>
</html>