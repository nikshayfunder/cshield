<!doctype html>
<html lang="en" class="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CShield â€¢ Add Reverse Proxy</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--bg:#09090b;--primary:#6366f1;--accent:#a855f7}
html,body{height:100%;scroll-behavior:smooth}
body{font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background-color:var(--bg);color:#e4e4e7;-webkit-font-smoothing:antialiased}
.glass{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(10px);transition:transform .2s,background .2s;overflow:hidden;position:relative}
.glass:hover{background:rgba(255,255,255,0.05);transform:translateY(-1px);box-shadow:0 10px 40px -10px rgba(0,0,0,0.5)}
.glass::after{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(800px circle at var(--mouse-x,0) var(--mouse-y,0),rgba(255,255,255,0.06),transparent 40%);opacity:0;transition:opacity .3s;pointer-events:none}
.glass:hover::after{opacity:1}
.bgfx{position:fixed;inset:0;background:
radial-gradient(40% 30% at 15% 10%,rgba(139,92,246,.10),transparent 60%),
radial-gradient(30% 30% at 85% 0,rgba(59,130,246,.08),transparent 60%),
radial-gradient(50% 40% at 50% 100%,rgba(16,185,129,.06),transparent 60%);filter:blur(44px);pointer-events:none}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.2)}
@keyframes pop{0%{transform:scale(.96);opacity:0}100%{transform:scale(1);opacity:1}}
.toast{animation:pop .25s ease-out both}
</style>
</head>
<body class="bg-[var(--bg)] text-zinc-200 antialiased min-h-screen overflow-x-hidden">
<div class="bgfx"></div>

<div class="fixed inset-0 z-[-1] pointer-events-none overflow-hidden">
  <div class="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-violet-500/10 rounded-full blur-[120px]"></div>
  <div class="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-fuchsia-500/10 rounded-full blur-[120px]"></div>
</div>

<div class="flex flex-col lg:flex-row min-h-screen">
  <aside class="lg:w-72 border-b lg:border-b-0 lg:border-r border-neutral-800/80 bg-black/40 backdrop-blur-xl flex lg:flex-col justify-between p-5 z-40 sticky top-0 lg:h-screen">
    <div class="flex flex-col gap-8">
      <div class="flex items-center gap-3 px-2">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-violet-500 to-fuchsia-600 flex items-center justify-center shadow-lg shadow-violet-500/30">
          <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
        </div>
        <div>
          <span class="font-bold text-zinc-100 tracking-tight block leading-none">CShield</span>
          <span class="text-[10px] uppercase tracking-[0.2em] text-zinc-500 font-medium">Edge Security</span>
        </div>
      </div>
      <nav class="flex lg:flex-col gap-1 overflow-x-auto lg:overflow-visible no-scrollbar text-sm">
        <a href="/dashboard" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 3.5L3 9v11h6v-7h6v7h6V9z"/>
          </svg>
          <span>Overview</span>
        </a>
        <a href="/analytics" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 5h16v2H4V5zm0 4h10v2H4v-2zm0 4h7v2H4v-2zm9 0h7v2h-7v-2z"/>
          </svg>
          <span>Traffic</span>
        </a>
        <a href="/features" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 6h16v2H4V6zm0 4h10v2H4v-2zm0 4h7v2H4v-2zm9 0h7v2h-7v-2z"/>
          </svg>
          <span>Features</span>
        </a>
        <a href="/proxies" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 5h18v4H3V5zm0 5h18v9H3v-9zm2 2v5h14v-5H5z"/>
          </svg>
          <span>Proxies</span>
        </a>
        <a href="/add_proxy" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium bg-white/5 text-white shadow-[0_0_0_1px_rgba(255,255,255,0.05)]">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 17v-4H6v-2h4V7h2v4h4v2h-4v4z"/>
          </svg>
          <span>Add Proxy</span>
        </a>
        <a href="/settings" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 8a4 4 0 1 0 .001 8.001A4 4 0 0 0 12 8zm8.94 4a7.96 7.96 0 0 0-.16-1.61l2.07-1.62l-2-3.46l-2.49 1a8.24 8.24 0 0 0-2.79-1.62l-.42-2.65H9.85l-.42 2.65a8.24 8.24 0 0 0-2.79 1.62l-2.49-1l-2 3.46l2.07 1.62A7.96 7.96 0 0 0 3.06 12c0 .55.06 1.09.16 1.61L1.15 15.23l2 3.46l2.49-1a8.24 8.24 0 0 0 2.79 1.62l.42 2.65h4.31l.42-2.65a8.24 8.24 0 0 0 2.79-1.62l2.49 1l2-3.46l-2.07-1.62c.1-.52.16-1.06.16-1.61z"/>
          </svg>
          <span>Settings</span>
        </a>
      </nav>
    </div>
  </aside>

  <main class="flex-1 p-4 lg:p-8 w-full max-w-[1920px] mx-auto space-y-6">
    <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 pb-2">
      <div>
        <h1 class="text-2xl font-semibold text-white tracking-tight">Create Reverse Proxy</h1>
        <p class="text-sm text-zinc-500 mt-1">Route traffic for your domain through CShield with optional CDN masking and upstream TLS.</p>
      </div>
    </header>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 glass rounded-2xl p-6">
        <form id="form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="col-span-1 md:col-span-2">
            <label class="block text-sm mb-1">Domain</label>
            <div class="relative">
              <input id="domain" type="text" placeholder="example.com"
                     class="peer w-full rounded-md bg-neutral-950/70 border border-neutral-900 px-3 py-2 outline-none focus:ring-2 focus:ring-violet-600">
              <div class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-neutral-600 peer-focus:text-violet-400 transition">
                <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3C7.03 3 3 7.03 3 12s4.03 9 9 9s9-4.03 9-9s-4.03-9-9-9m-1 16c-3.31 0-6-2.69-6-6c0-1.48.54-2.83 1.43-3.86l8.43 8.43C13.83 18.46 12.48 19 11 19m7-5c0 1.48-.54 2.83-1.43 3.86L8.14 10.43A5.98 5.98 0 0 1 18 10c0 3.31-2.69 6-6 6"/></svg>
              </div>
            </div>
          </div>

          <div class="col-span-1 md:col-span-2">
            <label class="block text-sm mb-1">Upstream</label>
            <input id="upstream" type="text"
                   placeholder="https://188.209.129.19:443 or https+insecure://188.209.129.19:443 or http://10.0.0.5:8080"
                   class="w-full rounded-md bg-neutral-950/70 border border-neutral-900 px-3 py-2 outline-none focus:ring-2 focus:ring-violet-600">
            <p class="mt-1 text-[11px] text-zinc-500">
              Supported schemes: <code>http://ip:port</code>, <code>https://ip:port</code> (strict), <code>https+insecure://ip:port</code> (skip cert verification).
              Port is optional and defaults to 80 for HTTP and 443 for HTTPS.
            </p>
          </div>
 
          <div class="col-span-1 md:col-span-2 flex items-center gap-6 mt-2">
            <label class="inline-flex items-center gap-2">
              <input id="cdn" type="checkbox" class="w-4 h-4 accent-violet-600">
              <span class="text-sm inline-flex items-center gap-2">
                <svg width="14" height="14" viewBox="0 0 24 24" class="opacity-80"><path fill="currentColor" d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2m-1 5v6l5 3l-1 1.73l-6-3.47V7h2z"/></svg>
                CDN (hide origin IP)
              </span>
            </label>
          </div>

          <div class="col-span-1 md:col-span-2 flex items-center justify-between mt-2">
            <div id="msg" class="text-xs text-zinc-400 inline-flex items-center gap-2">
              <span class="inline-block w-1.5 h-1.5 rounded-full bg-neutral-600"></span>
              Ready
            </div>
            <button class="rounded-md bg-violet-600 hover:bg-violet-500 px-4 py-2 text-sm font-medium inline-flex items-center gap-2">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M17 3H7v18l5-5l5 5V3z"/></svg>
              Create
            </button>
          </div>
        </form>
      </div>

      <div class="glass rounded-2xl p-6">
        <div class="flex items-center gap-3 mb-2">
          <div class="h-7 w-7 rounded-md bg-neutral-900 grid place-items-center">
            <svg width="16" height="16" viewBox="0 0 24 24" class="text-emerald-400"><path fill="currentColor" d="M9 16.2l-3.5-3.5L4 14.2L9 19l11-11l-1.5-1.5z"/></svg>
          </div>
          <h2 class="font-semibold">Notes</h2>
        </div>
        <ul class="list-disc list-inside text-sm text-zinc-300 space-y-1">
          <li>When TLS is checked, CShield connects to the origin using HTTPS with SNI set to your domain.</li>
          <li>Proxy configuration is stored in MongoDB and takes effect immediately.</li>
          <li>Global features are controlled from Settings and Dashboard.</li>
        </ul>
      </div>
    </section>

    <div id="toast" class="fixed bottom-5 right-5 hidden">
      <div class="toast rounded-lg border border-neutral-800 bg-neutral-900/90 px-4 py-3 text-sm shadow-xl flex items-center gap-2">
        <span class="inline-block h-2 w-2 rounded-full bg-emerald-500"></span>
        <span id="toastMsg">Created</span>
      </div>
    </div>
  </main>
</div>

<script>
const form = document.getElementById("form");
const domain = document.getElementById("domain");
const upstream = document.getElementById("upstream");
const cdn = document.getElementById("cdn");
const msg = document.getElementById("msg");
const toast = document.getElementById("toast");
const toastMsg = document.getElementById("toastMsg");

function setMsg(text, tone){
  msg.textContent = text || "";
  const dot = msg.querySelector("span");
  if(!dot) return;
  dot.className = "inline-block w-1.5 h-1.5 rounded-full " + (
    tone==="ok" ? "bg-emerald-500" :
    tone==="warn" ? "bg-amber-500" :
    tone==="err" ? "bg-rose-500" : "bg-neutral-600"
  );
}

function showToast(text){
  if(!toast) return;
  if(toastMsg) toastMsg.textContent = text || "Done";
  toast.classList.remove("hidden");
  setTimeout(()=> toast.classList.add("hidden"), 2000);
}

function validDomain(d){
  return /^[a-z0-9.-]+$/i.test(d) && d.indexOf(".")>0 && d.length<=253;
}

function parseUpstream(raw){
  let v = (raw || "").trim();
  if(!v) return null;
  let tls = false;
  let insecure = null; // null = default behaviour, true/false explicit
  const HTTPS_INSECURE = "https+insecure://";
  const HTTPS = "https://";
  const HTTP = "http://";
  if(v.toLowerCase().startsWith(HTTPS_INSECURE)){
    tls = true;
    insecure = true;
    v = v.slice(HTTPS_INSECURE.length);
  } else if(v.toLowerCase().startsWith(HTTPS)){
    tls = true;
    insecure = false;
    v = v.slice(HTTPS.length);
  } else if(v.toLowerCase().startsWith(HTTP)){
    tls = false;
    v = v.slice(HTTP.length);
  } else {
    return null;
  }
  v = v.trim();
  if(!v) return null;
  let host = v;
  let port = 0;
  const idx = v.lastIndexOf(":");
  if(idx > 0 && v.indexOf("]") < idx){ // basic IPv4 / host:port, ignore IPv6 for now
    host = v.slice(0, idx);
    const pv = parseInt(v.slice(idx+1), 10);
    if(!Number.isFinite(pv) || pv <= 0 || pv > 65535) return null;
    port = pv;
  }
  if(port === 0){
    port = tls ? 443 : 80;
  }
  host = host.trim();
  if(!host) return null;
  return { ip: host, port, tls, insecure };
}

form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  setMsg("", "");
  const d = domain.value.trim().toLowerCase();
  const us = upstream.value.trim();
  if(!validDomain(d)){ setMsg("Invalid domain", "err"); domain.focus(); return; }
  const parsed = parseUpstream(us);
  if(!parsed){ setMsg("Invalid upstream, use e.g. https://ip:443 or https+insecure://ip:443", "err"); upstream.focus(); return; }

  setMsg("Creating...", "warn");
  const body = {
    domain: d,
    ip: parsed.ip,
    port: parsed.port,
    cdn: cdn.checked,
    tls: parsed.tls
  };
  if(parsed.insecure !== null){
    body.insecure_tls = parsed.insecure;
  }
  try{
    const res = await fetch("/v1/api/proxies/add", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    if(res.ok){
      setMsg("Created and reloaded", "ok");
      showToast("Proxy created");
      domain.value=""; ip.value=""; port.value="80"; cdn.checked=false; tls.checked=false;
    } else {
      setMsg("Failed to create proxy", "err");
    }
  }catch(_){
    setMsg("Failed to create proxy", "err");
  }
});
</script>
</body>
</html>