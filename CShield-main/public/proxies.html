<!doctype html>
<html lang="en" class="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CShield • Proxies</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--bg:#09090b;--primary:#6366f1;--accent:#a855f7}
html,body{height:100%;scroll-behavior:smooth}
body{font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background-color:var(--bg);color:#e4e4e7;-webkit-font-smoothing:antialiased}
.glass{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(10px);transition:transform .2s,background .2s;overflow:hidden;position:relative}
.glass:hover{background:rgba(255,255,255,0.05);transform:translateY(-1px);box-shadow:0 10px 40px -10px rgba(0,0,0,0.5)}
.glass::after{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(800px circle at var(--mouse-x,0) var(--mouse-y,0),rgba(255,255,255,0.06),transparent 40%);opacity:0;transition:opacity .3s;pointer-events:none}
.glass:hover::after{opacity:1}
.bgfx{position:fixed;inset:0;background:
radial-gradient(40% 30% at 15% 10%,rgba(139,92,246,.10),transparent 60%),
radial-gradient(30% 30% at 85% 0,rgba(59,130,246,.08),transparent 60%),
radial-gradient(50% 40% at 50% 100%,rgba(16,185,129,.06),transparent 60%);filter:blur(44px);pointer-events:none}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.2)}
</style>
</head>
<body class="bg-[var(--bg)] text-zinc-200 antialiased min-h-screen overflow-x-hidden">
<div class="bgfx"></div>

<div class="fixed inset-0 z-[-1] pointer-events-none overflow-hidden">
  <div class="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-violet-500/10 rounded-full blur-[120px]"></div>
  <div class="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-fuchsia-500/10 rounded-full blur-[120px]"></div>
</div>

<div class="flex flex-col lg:flex-row min-h-screen">
  <aside class="lg:w-72 border-b lg:border-b-0 lg:border-r border-neutral-800/80 bg-black/40 backdrop-blur-xl flex lg:flex-col justify-between p-5 z-40 sticky top-0 lg:h-screen">
    <div class="flex flex-col gap-8">
      <div class="flex items-center gap-3 px-2">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-violet-500 to-fuchsia-600 flex items-center justify-center shadow-lg shadow-violet-500/30">
          <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
        </div>
        <div>
          <span class="font-bold text-zinc-100 tracking-tight block leading-none">CShield</span>
          <span class="text-[10px] uppercase tracking-[0.2em] text-zinc-500 font-medium">Edge Security</span>
        </div>
      </div>
      <nav class="flex lg:flex-col gap-1 overflow-x-auto lg:overflow-visible no-scrollbar text-sm">
        <a href="/dashboard" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 3.5L3 9v11h6v-7h6v7h6V9z"/>
          </svg>
          <span>Overview</span>
        </a>
        <a href="/analytics" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 5h16v2H4V5zm0 4h10v2H4v-2zm0 4h7v2H4v-2zm9 0h7v2h-7v-2z"/>
          </svg>
          <span>Traffic</span>
        </a>
        <a href="/features" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 6h16v2H4V6zm0 4h10v2H4v-2zm0 4h7v2H4v-2zm9 0h7v2h-7v-2z"/>
          </svg>
          <span>Features</span>
        </a>
        <a href="/proxies" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium bg-white/5 text-white shadow-[0_0_0_1px_rgba(255,255,255,0.05)]">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 5h18v4H3V5zm0 5h18v9H3v-9zm2 2v5h14v-5H5z"/>
          </svg>
          <span>Proxies</span>
        </a>
        <a href="/add_proxy" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 17v-4H6v-2h4V7h2v4h4v2h-4v4z"/>
          </svg>
          <span>Add Proxy</span>
        </a>
        <a href="/settings" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 8a4 4 0 1 0 .001 8.001A4 4 0 0 0 12 8zm8.94 4a7.96 7.96 0 0 0-.16-1.61l2.07-1.62l-2-3.46l-2.49 1a8.24 8.24 0 0 0-2.79-1.62l-.42-2.65H9.85l-.42 2.65a8.24 8.24 0 0 0-2.79 1.62l-2.49-1l-2 3.46l2.07 1.62A7.96 7.96 0 0 0 3.06 12c0 .55.06 1.09.16 1.61L1.15 15.23l2 3.46l2.49-1a8.24 8.24 0 0 0 2.79 1.62l.42 2.65h4.31l.42-2.65a8.24 8.24 0 0 0 2.79-1.62l2.49 1l2-3.46l-2.07-1.62c.1-.52.16-1.06.16-1.61z"/>
          </svg>
          <span>Settings</span>
        </a>
      </nav>
    </div>
  </aside>

  <main class="flex-1 p-4 lg:p-8 w-full max-w-[1920px] mx-auto space-y-6">
    <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 pb-2">
      <div>
        <h1 class="text-2xl font-semibold text-white tracking-tight">Reverse Proxies</h1>
        <p class="text-sm text-zinc-500 mt-1">Manage domains and their upstream origins behind CShield.</p>
      </div>
      <a href="/add_proxy" class="inline-flex items-center gap-2 rounded-lg bg-violet-600 hover:bg-violet-500 px-3 py-1.5 text-xs font-medium shadow-lg shadow-violet-500/20">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M10 17v-4H6v-2h4V7h2v4h4v2h-4v4z"/></svg>
        Add Proxy
      </a>
    </header>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <aside class="glass rounded-2xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="inline-flex items-center gap-2">
            <div class="h-6 w-6 rounded-md bg-neutral-900 grid place-items-center">
              <svg width="14" height="14" viewBox="0 0 24 24" class="text-violet-400"><path fill="currentColor" d="M4 4h16v4H4V4zm0 6h7v10H4V10zm9 0h7v10h-7V10z"/></svg>
            </div>
            <h2 class="font-semibold text-sm text-zinc-200">Configured Proxies</h2>
          </div>
          <button id="refresh" class="rounded-md bg-neutral-900 hover:bg-neutral-800 px-3 py-1.5 text-xs inline-flex items-center gap-2 transition">
            <svg width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M12 6V3L8 7l4 4V8a4 4 0 1 1-4 4H6a6 6 0 1 0 6-6z"/></svg>
            Refresh
          </button>
        </div>
        <ul id="plist" class="text-sm text-zinc-300 space-y-2 max-h-[60vh] overflow-auto"></ul>
      </aside>

      <section class="lg:col-span-2 glass rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <div class="text-xs text-zinc-400">Managing</div>
            <div id="pdomain" class="text-lg font-semibold text-zinc-100">—</div>
          </div>
          <div class="text-xs text-zinc-500 max-w-xs text-right">
            Proxies inherit global CShield features. Configure global behavior from Settings and the main dashboard.
          </div>
        </div>

        <div id="meta" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
          <div class="rounded-lg border border-neutral-900 p-3 bg-neutral-950/40">
            <div class="text-xs text-zinc-500 mb-1">Origin</div>
            <div id="origin" class="text-zinc-200 text-sm">—</div>
          </div>
          <div class="rounded-lg border border-neutral-900 p-3 bg-neutral-950/40">
            <div class="text-xs text-zinc-500 mb-1">Mode</div>
            <div id="mode" class="text-zinc-200 text-sm">—</div>
          </div>
        </div>

        <div class="space-y-4">
          <div>
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm font-medium text-zinc-200">LB Upstreams</div>
              <div class="flex items-center gap-2">
                <div id="lbm" class="text-xs text-zinc-500"></div>
                <button id="lbEdit" class="text-[11px] px-2 py-1 rounded-md border border-neutral-800 bg-neutral-950/60 hover:bg-neutral-900 transition">
                  Edit
                </button>
              </div>
            </div>
            <div id="lbpool" class="flex flex-wrap gap-2"></div>
            <div id="lbEditPanel" class="mt-3 space-y-2 hidden">
              <textarea id="lbEditInput"
                class="w-full rounded-md bg-neutral-950/70 border border-neutral-900 px-3 py-2 text-xs font-mono outline-none focus:border-violet-500 focus:shadow-[0_0_0_1px_rgba(139,92,246,.7)]"
                rows="3"
                spellcheck="false"
                placeholder="https://origin1.example.com:443, https://origin2.example.com:443"></textarea>
              <div class="flex items-center justify-between text-[11px]">
                <span id="lbEditMsg" class="text-zinc-500"></span>
                <div class="space-x-2">
                  <button id="lbEditCancel" class="px-2 py-1 rounded-md bg-neutral-900 hover:bg-neutral-800 border border-neutral-800">Cancel</button>
                  <button id="lbEditSave" class="px-2 py-1 rounded-md bg-violet-600 hover:bg-violet-500 text-white">Save</button>
                </div>
              </div>
              <p class="text-[11px] text-zinc-500">
                One upstream per line or comma‑separated. Examples: <code>https://origin1.example.com:443</code>, <code>http://10.0.0.5:8080</code>.
              </p>
            </div>
          </div>
        </div>

        <div id="msg" class="mt-4 text-xs text-zinc-400"></div>
      </section>
    </section>
  </main>
</div>

<script>
const plist=document.getElementById("plist");
const pdomain=document.getElementById("pdomain");
const origin=document.getElementById("origin");
const mode=document.getElementById("mode");
const msg=document.getElementById("msg");
const refreshBtn=document.getElementById("refresh");
const lbm=document.getElementById("lbm");
const lbpool=document.getElementById("lbpool");
const lbEditBtn=document.getElementById("lbEdit");
const lbEditPanel=document.getElementById("lbEditPanel");
const lbEditInput=document.getElementById("lbEditInput");
const lbEditMsg=document.getElementById("lbEditMsg");
const lbEditSave=document.getElementById("lbEditSave");
const lbEditCancel=document.getElementById("lbEditCancel");
let currentDomain="";
let lbState={method:"round_robin",pools:{}};
let lbConfig=null;

function el(tag,cls){const e=document.createElement(tag);if(cls)e.className=cls;return e}

async function listProxies(){
  plist.innerHTML="";
  try{
    const r=await fetch("/v1/api/proxies/list");
    if(!r.ok){msg.textContent="Failed to list proxies";return}
    const j=await r.json();
    const files=(j.files||[]);
    if(files.length===0){msg.textContent="No proxies configured";return}
    files.forEach(domain=>{
      const li=el("li");
      const row=el("div","w-full flex items-center justify-between rounded-md border border-neutral-900 bg-neutral-950/60 px-3 py-2");
      const b=el("button","flex items-center flex-1 text-left hover:text-white transition");
      b.setAttribute("data-domain",domain);
      const lbl=el("span");
      lbl.textContent=domain;
      const dot=el("span","inline-block w-2 h-2 rounded-full ml-2 bg-neutral-600");
      dot.setAttribute("data-dot","1");
      b.append(lbl,dot);
      b.addEventListener("click",()=>loadProxy(domain));
      const del=el("button","ml-3 text-xs px-2 py-1 rounded-md bg-rose-600 hover:bg-rose-500 transition");
      del.textContent="Delete";
      del.addEventListener("click",ev=>{ev.stopPropagation();deleteProxy(domain)});
      row.append(b,del);
      li.appendChild(row);
      plist.appendChild(li);
    });
    renderListHealth();
  }catch(_){
    msg.textContent="Failed to list proxies";
  }
}

function renderListHealth(){
  Array.from(plist.querySelectorAll("button[data-domain]")).forEach(b=>{
    const domain=b.getAttribute("data-domain");
    const d=b.querySelector("span[data-dot]");
    if(!d)return;
    let pool=(lbState.pools&&lbState.pools[domain])||[];
    if((!pool||!pool.length) && lbState.pools && lbState.pools["*"]){
      pool=lbState.pools["*"];
    }
    let cls="bg-neutral-600";
    if(pool.length){cls=pool.some(u=>u.alive)?"bg-emerald-500":"bg-rose-500"}
    d.className="inline-block w-2 h-2 rounded-full ml-2 "+cls;
  });
}

async function refreshLbState(){
  try{
    const r=await fetch("/v1/api/lb/state");
    if(!r.ok)return;
    const j=await r.json();
    lbState=j||{method:"round_robin",pools:{}};
    renderListHealth();
    if(currentDomain)renderDomainLB(currentDomain);
  }catch(_){}
}

function renderDomainLB(domain){
  if(!lbpool||!lbm)return;
  lbpool.innerHTML="";
  lbm.textContent="Method: "+(lbState.method||"round_robin");
  let ups=(lbState.pools&&lbState.pools[domain])||[];
  if((!ups||!ups.length) && lbState.pools && lbState.pools["*"]){
    ups=lbState.pools["*"];
  }
  ups.forEach(u=>{
    const chip=el("div","text-xs px-2 py-1 rounded-md border border-neutral-900 bg-neutral-900/60 flex items-center gap-2");
    const dot=el("span","inline-block w-2 h-2 rounded-full "+(u.alive?"bg-emerald-500":"bg-rose-500"));
    const addr=el("span");
    addr.textContent=(u.is_tls?"https://":"http://")+u.addr;
    const cn=el("span","text-neutral-400");
    cn.textContent="c="+(u.conns||0);
    chip.append(dot,addr,cn);
    lbpool.appendChild(chip);
  });
  if(ups.length===0){
    const t=el("div","text-xs text-neutral-400");
    t.textContent="No upstreams configured for this domain";
    lbpool.appendChild(t);
  }
}

function currentUpstreamsForDomain(domain){
  let ups=(lbState.pools&&lbState.pools[domain])||[];
  if((!ups||!ups.length) && lbState.pools && lbState.pools["*"]){
    ups=lbState.pools["*"];
  }
  return ups||[];
}

async function ensureLbConfigLoaded(){
  if(lbConfig) return true;
  try{
    const r=await fetch("/v1/api/configs/read?path=load_balancer.json");
    if(!r.ok) return false;
    const j=await r.json();
    lbConfig=JSON.parse(j.content||"{}");
    if(!lbConfig.pools) lbConfig.pools={};
    if(!Array.isArray(lbConfig.targets)) lbConfig.targets=[];
    return true;
  }catch(_){
    return false;
  }
}

function openLbEditor(){
  if(!currentDomain){
    if(lbEditMsg) lbEditMsg.textContent="Select a proxy first";
    return;
  }
  if(!lbEditPanel || !lbEditInput) return;
  const ups=currentUpstreamsForDomain(currentDomain);
  if(ups.length){
    const lines=ups.map(u=>{
      const scheme=u.is_tls?"https://":"http://";
      return scheme+u.addr;
    });
    lbEditInput.value=lines.join("\n");
  }else{
    lbEditInput.value="";
  }
  lbEditMsg.textContent="";
  lbEditPanel.classList.remove("hidden");
}

function closeLbEditor(){
  if(lbEditPanel){
    lbEditPanel.classList.add("hidden");
  }
  if(lbEditMsg){
    lbEditMsg.textContent="";
  }
}

async function saveLbEditor(){
  if(!currentDomain || !lbEditInput) return;
  lbEditMsg.textContent="Saving...";
  const ok=await ensureLbConfigLoaded();
  if(!ok){
    lbEditMsg.textContent="Failed to load load_balancer.json";
    return;
  }
  const raw=lbEditInput.value||"";
  const parts=raw.split(/[\n,]/).map(s=>s.trim()).filter(Boolean);
  if(!lbConfig.pools) lbConfig.pools={};
  if(parts.length===0){
    delete lbConfig.pools[currentDomain];
  }else{
    lbConfig.pools[currentDomain]=parts;
  }
  try{
    const body={path:"load_balancer.json",content:JSON.stringify(lbConfig)};
    const r=await fetch("/v1/api/configs/save",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    });
    if(!r.ok){
      lbEditMsg.textContent="Save failed";
      return;
    }
    lbEditMsg.textContent="Saved";
    closeLbEditor();
    await refreshLbState();
  }catch(_){
    lbEditMsg.textContent="Save failed";
  }
}

async function loadProxy(domain){
  msg.textContent="Loading "+domain+"...";
  try{
    const r=await fetch("/v1/api/proxies/get?domain="+encodeURIComponent(domain));
    if(!r.ok){msg.textContent="Failed to load "+domain;return}
    const j=await r.json();
    currentDomain=j.domain||domain;
    pdomain.textContent=currentDomain;
    try{
      const cfg=JSON.parse(j.content||"{}");
      origin.textContent=(cfg.ip||"-")+":"+(cfg.port||"-");
      mode.textContent=(cfg.tls?"https":"http")+" • CDN:"+(cfg.cdn?"on":"off");
      renderDomainLB(currentDomain);
      msg.textContent="Loaded";
    }catch(e){
      msg.textContent="Invalid proxy configuration";
    }
  }catch(_){
    msg.textContent="Failed to load "+domain;
  }
}

async function deleteProxy(domain){
  if(!domain)return;
  if(!confirm("Delete proxy "+domain+"?"))return;
  msg.textContent="Deleting "+domain+"...";
  try{
    const r=await fetch("/v1/api/proxies/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({domain})});
    if(!r.ok){msg.textContent="Failed to delete "+domain;return}
    msg.textContent="Deleted "+domain;
    if(currentDomain===domain){
      currentDomain="";
      pdomain.textContent="—";
      origin.textContent="—";
      mode.textContent="—";
      lbpool.innerHTML="";
      lbm.textContent="";
    }
    await listProxies();
    await refreshLbState();
  }catch(_){
    msg.textContent="Failed to delete "+domain;
  }
}

refreshBtn.addEventListener("click",listProxies);
if(lbEditBtn) lbEditBtn.addEventListener("click",openLbEditor);
if(lbEditCancel) lbEditCancel.addEventListener("click",closeLbEditor);
if(lbEditSave) lbEditSave.addEventListener("click",saveLbEditor);

(async()=>{await listProxies();await refreshLbState();setInterval(refreshLbState,3000)})();
</script>
</body>
</html>