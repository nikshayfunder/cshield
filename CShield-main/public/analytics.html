<!doctype html>
<html lang="en" class="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CShield • Analytics</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j7kGICpbJzi3sRoqbZbE8R9uMB6vT9A72G2z8j0=" crossorigin=""></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{--bg:#09090b;--primary:#6366f1;--accent:#a855f7}
html,body{height:100%;scroll-behavior:smooth}
body{font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background-color:var(--bg);color:#e4e4e7;-webkit-font-smoothing:antialiased}
.glass{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(10px);transition:transform .2s,background .2s;overflow:hidden;position:relative}
.glass:hover{background:rgba(255,255,255,0.05);transform:translateY(-1px);box-shadow:0 10px 40px -10px rgba(0,0,0,0.5)}
.glass::after{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(800px circle at var(--mouse-x,0) var(--mouse-y,0),rgba(255,255,255,0.06),transparent 40%);opacity:0;transition:opacity .3s;pointer-events:none}
.glass:hover::after{opacity:1}
.bgfx{position:fixed;inset:0;background:
radial-gradient(40% 30% at 15% 10%,rgba(139,92,246,.10),transparent 60%),
radial-gradient(30% 30% at 85% 0,rgba(59,130,246,.08),transparent 60%),
radial-gradient(50% 40% at 50% 100%,rgba(16,185,129,.06),transparent 60%);filter:blur(44px);pointer-events:none}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.2)}
.leaflet-container{background:#09090b!important;font-family:'Inter',sans-serif}
.leaflet-popup-content-wrapper,.leaflet-popup-tip{background:rgba(24,24,27,0.95);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.1);color:#fff;border-radius:.75rem}
.leaflet-popup-content{margin:12px}
.leaflet-popup-tip{box-shadow:none}
</style>
</head>
<body class="bg-[var(--bg)] text-zinc-200 antialiased min-h-screen overflow-x-hidden">
<div class="bgfx"></div>

<div class="fixed inset-0 z-[-1] pointer-events-none overflow-hidden">
  <div class="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-violet-500/10 rounded-full blur-[120px]"></div>
  <div class="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-fuchsia-500/10 rounded-full blur-[120px]"></div>
</div>

<div class="flex flex-col lg:flex-row min-h-screen">
  <aside class="lg:w-72 border-b lg:border-b-0 lg:border-r border-neutral-800/80 bg-black/40 backdrop-blur-xl flex lg:flex-col justify-between p-5 z-40 sticky top-0 lg:h-screen">
    <div class="flex flex-col gap-8">
      <div class="flex items-center gap-3 px-2">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-violet-500 to-fuchsia-600 flex items-center justify-center shadow-lg shadow-violet-500/30">
          <svg class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
        </div>
        <div>
          <span class="font-bold text-zinc-100 tracking-tight block leading-none">CShield</span>
          <span class="text-[10px] uppercase tracking-[0.2em] text-zinc-500 font-medium">Edge Security</span>
        </div>
      </div>
      <nav class="flex lg:flex-col gap-1 overflow-x-auto lg:overflow-visible no-scrollbar text-sm">
        <a href="/dashboard" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 3.5L3 9v11h6v-7h6v7h6V9z"/>
          </svg>
          <span>Overview</span>
        </a>
        <a href="/analytics" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium bg-white/5 text-white shadow-[0_0_0_1px_rgba(255,255,255,0.05)]">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 5h16v2H4V5zm0 4h10v2H4v-2zm0 4h7v2H4v-2zm9 0h7v2h-7v-2z"/>
          </svg>
          <span>Traffic</span>
        </a>
        <a href="/features" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 6h16v2H4V6zm0 4h10v2H4v-2zm0 4h7v2H4v-2zm9 0h7v2h-7v-2z"/>
          </svg>
          <span>Features</span>
        </a>
        <a href="/proxies" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 5h18v4H3V5zm0 5h18v9H3v-9zm2 2v5h14v-5H5z"/>
          </svg>
          <span>Proxies</span>
        </a>
        <a href="/add_proxy" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 17v-4H6v-2h4V7h2v4h4v2h-4v4z"/>
          </svg>
          <span>Add Proxy</span>
        </a>
        <a href="/settings" class="nav-link flex items-center gap-3 px-3 py-2.5 rounded-lg font-medium text-zinc-400 hover:text-zinc-100 hover:bg-white/5 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 8a4 4 0 1 0 .001 8.001A4 4 0 0 0 12 8zm8.94 4a7.96 7.96 0 0 0-.16-1.61l2.07-1.62l-2-3.46l-2.49 1a8.24 8.24 0 0 0-2.79-1.62l-.42-2.65H9.85l-.42 2.65a8.24 8.24 0 0 0-2.79 1.62l-2.49-1l-2 3.46l-2.07-1.62c.1-.52.16-1.06.16-1.61z"/>
          </svg>
          <span>Settings</span>
        </a>
      </nav>
    </div>
  </aside>

  <main class="flex-1 p-4 lg:p-8 w-full max-w-[1920px] mx-auto space-y-6">
    <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 pb-2">
      <div>
        <h1 class="text-2xl font-semibold text-white tracking-tight">Traffic & Threat Analytics</h1>
        <p class="text-sm text-zinc-500 mt-1">Real-time attack stream and global map from your edge.</p>
      </div>
    </header>

    <section class="glass rounded-2xl p-6">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div class="text-sm font-semibold text-zinc-200">Threat Intelligence</div>
          <div class="text-xs text-zinc-500">Recent security events from the edge.</div>
        </div>
        <div class="flex items-center gap-2 text-[11px] text-zinc-500">
          <span class="inline-flex h-1.5 w-1.5 rounded-full bg-red-500 animate-pulse"></span>
          Live Feed
        </div>
      </div>
      <div class="overflow-auto max-h-80">
        <table class="w-full text-xs md:text-sm">
          <thead class="text-zinc-500 text-[11px] uppercase tracking-wide border-b border-white/5">
            <tr>
              <th class="text-left font-medium py-1 pr-2">Time</th>
              <th class="text-left font-medium py-1 pr-2">IP</th>
              <th class="text-left font-medium py-1 pr-2">Country</th>
              <th class="text-left font-medium py-1 pr-2">Method</th>
              <th class="text-left font-medium py-1 pr-2">Path</th>
              <th class="text-left font-medium py-1 pr-2">Reason</th>
              <th class="text-left font-medium py-1 pr-2">Action</th>
              <th class="text-left font-medium py-1 pr-2">Score</th>
              <th class="text-left font-medium py-1">UA</th>
            </tr>
          </thead>
          <tbody id="attackBody"></tbody>
        </table>
      </div>
      <div id="attackMsg" class="text-xs text-zinc-500 mt-2"></div>
    </section>

    <section class="space-y-6">
      <div class="glass rounded-2xl p-6 h-[320px]">
        <div class="flex justify-between items-center mb-3">
          <div class="text-sm font-semibold text-zinc-200">Global Threat Map</div>
          <div class="text-xs text-zinc-500">Live origin IPs by location, volume, and attacks</div>
        </div>
        <div id="geoMap" class="relative rounded-lg border border-neutral-800 bg-neutral-950/60 h-[260px] overflow-hidden"></div>
      </div>
      <div class="grid gap-6 lg:grid-cols-2">
        <div class="glass rounded-2xl p-6">
          <div class="flex items-center justify-between mb-3">
            <div class="text-sm font-semibold text-zinc-200">Top Attacking ASNs</div>
            <div class="text-xs text-zinc-500">Networks with highest block rate</div>
          </div>
          <div id="geoTopAsn" class="space-y-1 max-h-64 overflow-auto text-xs"></div>
        </div>
        <div class="glass rounded-2xl p-6">
          <div class="flex items-center justify-between mb-3">
            <div class="text-sm font-semibold text-zinc-200">Top Attacking Countries</div>
            <div class="text-xs text-zinc-500">Regions with highest block rate</div>
          </div>
          <div id="geoCountries" class="space-y-2 max-h-64 overflow-auto"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
function fmt(n){return Intl.NumberFormat().format(n)}
function el(t,c){const e=document.createElement(t);if(c)e.className=c;return e}

const attackBody=document.getElementById("attackBody")
const attackMsg=document.getElementById("attackMsg")
const geoMap=document.getElementById("geoMap")
const geoCountries=document.getElementById("geoCountries")
const geoTopAsn=document.getElementById("geoTopAsn")

let geoCountriesData=null
let geoPointsData=[]
let geoMapInstance=null
let geoLayerGroup=null

function truncate(s,m){if(!s)return"";if(s.length<=m)return s;return s.slice(0,m-1)+"…"}

function renderAttacks(list){
  if(!attackBody||!attackMsg)return
  attackBody.innerHTML=""
  if(!list||!list.length){
    attackMsg.textContent="No recent attacks"
    return
  }
  attackMsg.textContent=""
  const rows=list.slice(-200).reverse()
  rows.forEach(ev=>{
    const tr=el("tr","border-b border-neutral-800")
    const tTime=el("td","py-1 pr-2 align-top")
    const d=new Date((ev.time||0)*1000)
    tTime.textContent=isNaN(d.getTime())?"":d.toLocaleTimeString()
    const tIP=el("td","py-1 pr-2 align-top")
    tIP.textContent=ev.ip||""
    const tCountry=el("td","py-1 pr-2 align-top")
    const cc=(ev.country_code||"").toUpperCase()
    const cn=ev.country||""
    let countryLabel=cc?(cc+(cn?" • "+cn:"")):(cn||"")
    if(!countryLabel) countryLabel="Unknown"
    tCountry.textContent=countryLabel
    const tMethod=el("td","py-1 pr-2 align-top")
    tMethod.textContent=ev.method||""
    const tPath=el("td","py-1 pr-2 align-top")
    tPath.textContent=truncate(ev.path||"",40)
    const tReason=el("td","py-1 pr-2 align-top")
    tReason.textContent=ev.reason||""
    const tAction=el("td","py-1 pr-2 align-top")
    tAction.textContent=ev.action||""
    const tScore=el("td","py-1 pr-2 align-top")
    tScore.textContent=ev.score!=null?String(ev.score):""
    const tUA=el("td","py-1 align-top")
    tUA.textContent=truncate(ev.ua||"",80)
    tr.append(tTime,tIP,tCountry,tMethod,tPath,tReason,tAction,tScore,tUA)
    attackBody.appendChild(tr)
  })
}

async function loadAttacks(){
  if(!attackBody||!attackMsg)return
  attackMsg.textContent="Loading..."
  try{
    const r=await fetch("/v1/api/analytics/attacks")
    if(!r.ok){
      attackMsg.textContent="Failed to load"
      return
    }
    const j=await r.json()
    renderAttacks(j.events||[])
  }catch(_){
    attackMsg.textContent="Failed to load"
  }
}

function renderGeoFallback(points){
  if(!geoMap)return
  geoMap.innerHTML=""
  const wrap=el("div","w-full h-full relative overflow-hidden")
  wrap.style.position="relative"
  wrap.style.width="100%"
  wrap.style.height="100%"
  geoMap.appendChild(wrap)
  if(!Array.isArray(points))return
  points.forEach(function(p){
    const lat=Number(p.lat)
    const lon=Number(p.lon)
    if(!isFinite(lat)||!isFinite(lon))return
    if(lat>90||lat<-90||lon>180||lon<-180)return
    const x=(lon+180)/360*100
    const y=(90-lat)/180*100
    const req=Number(p.requests)||0
    const atk=Number(p.attacks)||0
    const hasAttacks=atk>0
    const dot=el("div","absolute rounded-full")
    const rBase=Math.log10(req+1)
    const r=4+Math.min(6,Math.max(0,rBase*2))
    dot.style.width=r+"px"
    dot.style.height=r+"px"
    dot.style.left=x+"%"
    dot.style.top=y+"%"
    dot.style.transform="translate(-50%,-50%)"
    dot.style.backgroundColor=hasAttacks?"#fb7185":"#22c55e"
    dot.style.boxShadow="0 0 8px "+(hasAttacks?"rgba(251,113,133,0.6)":"rgba(34,197,94,0.5)")
    dot.title=(p.ip||"")+(p.country?" • "+p.country:"")
    wrap.appendChild(dot)
  })
}

function renderGeo(data){
  if(!geoMap||!geoCountries)return
  const countries=data&&data.countries?data.countries:{}
  const points=data&&data.points?data.points:[]
  geoCountriesData=countries
  geoPointsData=points
  geoCountries.innerHTML=""
  geoTopAsn.innerHTML=""
  const entries=Object.entries(countries).map(function(it){return{code:it[0],count:Number(it[1])||0}})
  const hasPoints=Array.isArray(points)&&points.length>0
  if(!hasPoints&&entries.length===0){
    if(geoMap){
      geoMap.innerHTML=""
      const msg=el("div","w-full h-full flex items-center justify-center text-xs text-zinc-500")
      msg.textContent="No geo data yet"
      geoMap.appendChild(msg)
    }
    const msgCountries=el("div","text-xs text-zinc-500")
    msgCountries.textContent="No geo data yet"
    geoCountries.appendChild(msgCountries)
    const msgAsn=el("div","text-xs text-zinc-500")
    msgAsn.textContent="No ASN data yet"
    geoTopAsn.appendChild(msgAsn)
    return
  }
  entries.sort(function(a,b){return b.count-a.count})
  const sampleByCode={}
  points.forEach(function(p){
    var c=(p.country_code||"").toUpperCase()
    if(!c)return
    if(!sampleByCode[c])sampleByCode[c]=p
  })
  entries.slice(0,10).forEach(function(it){
    const row=el("div","flex items-center justify-between text-xs")
    const left=el("div","flex items-center gap-2")
    const badge=el("span","inline-flex items-center justify-center px-1.5 py-0.5 rounded bg-neutral-800 text-[10px] font-mono")
    badge.textContent=it.code.toUpperCase()
    const name=el("span","text-neutral-300")
    const sample=sampleByCode[it.code.toUpperCase()]
    name.textContent=(sample&&sample.country)?sample.country:it.code.toUpperCase()
    left.appendChild(badge)
    left.appendChild(name)
    const right=el("div","flex items-center gap-2")
    const num=el("span","text-neutral-200")
    num.textContent=fmt(it.count)
    const bar=el("div","h-1.5 w-20 bg-neutral-800 rounded-full overflow-hidden")
    const fill=el("div","h-full bg-violet-500 rounded-full")
    const maxCount=entries.length?entries[0].count:0
    const pct=maxCount?Math.max(4,Math.round((it.count/maxCount)*100)):0
    fill.style.width=pct+"%"
    bar.appendChild(fill)
    right.appendChild(num)
    right.appendChild(bar)
    row.appendChild(left)
    row.appendChild(right)
    geoCountries.appendChild(row)
  })
  const byAsn={}
  points.forEach(function(p){
    const asn=(p.asn||"").trim()
    if(!asn)return
    const weight=(Number(p.attacks)||0)||(Number(p.requests)||0)
    if(!weight)return
    byAsn[asn]=(byAsn[asn]||0)+weight
  })
  const asnEntries=Object.entries(byAsn).map(function(it){return{asn:it[0],count:Number(it[1])||0}})
  asnEntries.sort(function(a,b){return b.count-a.count})
  geoTopAsn.innerHTML=""
  asnEntries.slice(0,10).forEach(function(it){
    const row=el("div","flex items-center justify-between text-xs")
    const left=el("div","text-neutral-300")
    left.textContent=it.asn
    const right=el("div","flex items-center gap-2")
    const num=el("span","text-neutral-200")
    num.textContent=fmt(it.count)
    const bar=el("div","h-1.5 w-20 bg-neutral-800 rounded-full overflow-hidden")
    const fill=el("div","h-full bg-rose-500 rounded-full")
    const maxCount=asnEntries.length?asnEntries[0].count:0
    const pct=maxCount?Math.max(4,Math.round((it.count/maxCount)*100)):0
    fill.style.width=pct+"%"
    bar.appendChild(fill)
    right.appendChild(num)
    right.appendChild(bar)
    row.appendChild(left)
    row.appendChild(right)
    geoTopAsn.appendChild(row)
  })
  if(typeof L==="undefined"){
    renderGeoFallback(points)
    return
  }
  if(!geoMapInstance){
    geoMapInstance=L.map(geoMap,{worldCopyJump:true,attributionControl:false})
    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{
      attribution:"&copy; OpenStreetMap & CARTO",
      subdomains:"abcd",
      maxZoom:19
    }).addTo(geoMapInstance)
    geoLayerGroup=L.layerGroup().addTo(geoMapInstance)
    geoMapInstance.setView([20,0],2)
  }
  geoLayerGroup.clearLayers()
  points.forEach(function(p){
    const lat=Number(p.lat)
    const lon=Number(p.lon)
    if(!isFinite(lat)||!isFinite(lon))return
    if(lat>90||lat<-90||lon>180||lon<-180)return
    const req=Number(p.requests)||0
    const atk=Number(p.attacks)||0
    const rBase=Math.log10(req+1)
    const r=4+Math.min(8,Math.max(0,rBase*2))
    const hasAttacks=atk>0
    const color=hasAttacks?"#fb7185":"#22c55e"
    const m=L.circleMarker([lat,lon],{radius:r,color:color,weight:1,fillColor:color,fillOpacity:0.85})
    const locParts=[]
    if(p.city)locParts.push(p.city)
    if(p.region)locParts.push(p.region)
    if(p.country)locParts.push(p.country)
    const last=p.last_seen?new Date(p.last_seen*1000).toLocaleString():""
    let html=""
    if(p.ip)html+="<div class='font-semibold text-sm mb-1'>"+p.ip+"</div>"
    if(locParts.length)html+="<div class='text-xs text-neutral-200 mb-1'>"+locParts.join(", ")+"</div>"
    html+="<div class='grid grid-cols-2 gap-x-3 gap-y-0.5 text-[11px]'>"
    html+="<div class='text-neutral-400'>Requests</div><div class='text-neutral-100'>"+fmt(req)+"</div>"
    html+="<div class='text-neutral-400'>Attacks</div><div class='text-neutral-100'>"+fmt(atk)+"</div>"
    if(p.asn)html+="<div class='text-neutral-400'>ASN</div><div class='text-neutral-100'>"+p.asn+"</div>"
    if(p.org)html+="<div class='text-neutral-400'>Org</div><div class='text-neutral-100'>"+p.org+"</div>"
    if(p.timezone)html+="<div class='text-neutral-400'>TZ</div><div class='text-neutral-100'>"+p.timezone+"</div>"
    if(last)html+="<div class='text-neutral-400'>Last seen</div><div class='text-neutral-100'>"+last+"</div>"
    html+="</div>"
    m.bindPopup(html,{className:"bg-neutral-950/95 text-neutral-100 text-xs",maxWidth:260})
    geoLayerGroup.addLayer(m)
  })
}

async function loadGeo(){
  if(!geoMap||!geoCountries)return
  try{
    const r=await fetch("/v1/api/analytics/geo")
    if(r.ok){
      const j=await r.json()
      renderGeo(j)
      return
    }
  }catch(_){}
  if(!geoMapInstance){
    renderGeo({countries:geoCountriesData||{},points:geoPointsData||[]})
    if(geoMap&&!geoCountriesData){
      geoMap.textContent="No geo data yet"
    }
  }
}

;(function(){
  loadAttacks()
  loadGeo()
  setInterval(loadAttacks,6000)
  setInterval(loadGeo,4000)
})()
</script>
</body>
</html>